<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SCM Dropping Optimizer</title>
    
    <!-- 1. Tailwind CSS (Styling) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. React & ReactDOM (Core) -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- 3. Babel (Agar browser bisa baca kode React JSX) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- 4. SheetJS (Untuk baca Excel) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <!-- 5. Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        body { 
            background-color: #f8fafc; 
            font-family: 'Inter', sans-serif; 
            color: #1e293b;
        }
        
        .spin { animation: spin 1s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        
        .custom-scrollbar::-webkit-scrollbar { height: 8px; width: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f5f9; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        .glass-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(226, 232, 240, 0.8);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // --- 1. DATA RAYONISASI & PRIORITAS ---
        const RAYON_MAPPING = {
            'BDG': 'JABODUNGTABEK', 'BKS': 'JABODUNGTABEK', 'JKT': 'JABODUNGTABEK', 
            'TGR': 'JABODUNGTABEK', 'BGR': 'JABODUNGTABEK', 'JAK': 'JABODUNGTABEK', 'JKT3': 'JABODUNGTABEK',
            'JMR': 'JAWA TIMUR', 'SBY': 'JAWA TIMUR', 'DPS': 'JAWA TIMUR', 'MLG': 'JAWA TIMUR',
            'SLO': 'JAWA TENGAH', 'YGY': 'JAWA TENGAH', 'SMG': 'JAWA TENGAH', 
            'CRB': 'JAWA TENGAH', 'PWT': 'JAWA TENGAH',
            'PDG': 'SUMATERA', 'JBI': 'SUMATERA', 'PLB': 'SUMATERA', 'PKB': 'SUMATERA',
            'BLP': 'SUMATERA', 'BTM': 'SUMATERA', 'MDN': 'SUMATERA', 'NAD': 'SUMATERA',
            'ACE': 'SUMATERA', 'PLM': 'SUMATERA', 
            'BJM': 'CABANG JAUH', 'PTK': 'CABANG JAUH', 'MDO': 'CABANG JAUH', 
            'MKS': 'CABANG JAUH', 'SMD': 'CABANG JAUH', 'BPN': 'CABANG JAUH', 
            'PLU': 'CABANG JAUH', 'KDI': 'CABANG JAUH'
        };

        const PRIORITY_MATRIX = {
            'JABODUNGTABEK': ['JABODUNGTABEK', 'JAWA TENGAH', 'JAWA TIMUR', 'SUMATERA', 'CABANG JAUH'],
            'JAWA TENGAH':   ['JAWA TENGAH', 'JAWA TIMUR', 'JABODUNGTABEK', 'SUMATERA', 'CABANG JAUH'],
            'JAWA TIMUR':    ['JAWA TIMUR', 'JAWA TENGAH', 'JABODUNGTABEK', 'SUMATERA', 'CABANG JAUH'],
            'SUMATERA':      ['SUMATERA', 'JABODUNGTABEK', 'JAWA TENGAH', 'JAWA TIMUR', 'CABANG JAUH'],
            'CABANG JAUH':   ['JABODUNGTABEK', 'CABANG JAUH', 'JAWA TENGAH', 'JAWA TIMUR', 'SUMATERA']
        };

        const Icon = ({ name, size = 18, className = "" }) => {
            return <i data-lucide={name} width={size} height={size} className={className}></i>;
        };

        const getColLetter = (colIndex) => {
            let temp, letter = '';
            while (colIndex >= 0) {
                temp = (colIndex) % 26;
                letter = String.fromCharCode(temp + 65) + letter;
                colIndex = (colIndex - temp - 1) / 26;
            }
            return letter;
        };

        const getColIndex = (letter) => {
            let column = 0;
            const length = letter.length;
            for (let i = 0; i < length; i++) {
                column += (letter.charCodeAt(i) - 64) * Math.pow(26, length - i - 1);
            }
            return column - 1;
        };

        const getRayon = (branchCode) => {
            if (!branchCode) return 'UNKNOWN';
            const cleanCode = String(branchCode).toUpperCase().replace(/[^A-Z]/g, '');
            const prefix3 = cleanCode.substring(0, 3);
            return RAYON_MAPPING[prefix3] || 'OTHER';
        };

        const PRIORITY_CACHE = {};
        const getPriorityScore = (sourceRayon, destRayon) => {
            const key = `${sourceRayon}|${destRayon}`;
            if (PRIORITY_CACHE[key]) return PRIORITY_CACHE[key];
            const priorities = PRIORITY_MATRIX[destRayon];
            if (!priorities) return 99;
            const idx = priorities.indexOf(sourceRayon);
            const score = idx === -1 ? 99 : idx + 1;
            PRIORITY_CACHE[key] = score;
            return score;
        };

        const parseSmartNumber = (val) => {
            if (typeof val === 'number') return Math.floor(val);
            if (!val) return 0;
            const strVal = String(val).trim();
            if (strVal === '-' || strVal === '') return 0;
            const parsed = parseFloat(strVal.replace(',', '.'));
            return isNaN(parsed) ? 0 : Math.floor(parsed);
        };

        const Toast = ({ message, type, onClose }) => {
            if (!message) return null;
            const bgClass = type === 'error' ? 'bg-red-50 text-red-700 border-red-200' : 'bg-green-50 text-green-700 border-green-200';
            const iconName = type === 'error' ? 'alert-circle' : 'check-circle-2';
            return (
                <div className={`fixed top-6 right-6 z-50 px-4 py-3 rounded-lg shadow-xl border flex items-center gap-3 animate-fade-in-down ${bgClass}`}>
                    <Icon name={iconName} size={20} />
                    <span className="font-medium text-sm">{message}</span>
                    <button onClick={onClose} className="opacity-60 hover:opacity-100 ml-2"><Icon name="x" size={16} /></button>
                </div>
            );
        };

        const LoadingOverlay = () => (
            <div className="fixed inset-0 bg-white/80 backdrop-blur-sm z-[60] flex flex-col items-center justify-center">
                <div className="w-12 h-12 border-4 border-blue-200 border-t-blue-600 rounded-full spin mb-4"></div>
                <h3 className="text-lg font-bold text-gray-800">Sedang Menganalisa...</h3>
                <p className="text-gray-500 text-sm">Mohon tunggu, memproses ribuan data</p>
            </div>
        );

        const App = () => {
            const [step, setStep] = React.useState(1);
            const [workbook, setWorkbook] = React.useState(null);
            const [sheetName, setSheetName] = React.useState('');
            const [previewData, setPreviewData] = React.useState([]);
            const [headerRowIndex, setHeaderRowIndex] = React.useState(4);
            const [suggestions, setSuggestions] = React.useState([]);
            const [searchTerm, setSearchTerm] = React.useState('');
            const [isProcessing, setIsProcessing] = React.useState(false);
            const [allocationsMap, setAllocationsMap] = React.useState({}); 

            const [currentPage, setCurrentPage] = React.useState(1);
            const [itemsPerPage, setItemsPerPage] = React.useState(50);

            const [columnFilters, setColumnFilters] = React.useState({ product: '', priority: 'ALL', source: '', destination: '', qty: '' });
            const [notification, setNotification] = React.useState({ message: '', type: '' });
            
            const showNotify = (msg, type = 'error') => {
                setNotification({ message: msg, type });
                setTimeout(() => setNotification({ message: '', type: '' }), 5000);
            };

            const [colMapping, setColMapping] = React.useState({
                branch: 'A', productCode: 'E', productDesc: 'F', planDrop: 'AY', overStock: 'AZ', multiple: 'AP'
            });

            const [calcConfig, setCalcConfig] = React.useState({ stockCol: 'AA', salesCol: 'V', bufferCol: 'AL' });

            React.useEffect(() => {
                lucide.createIcons();
            }); 

            const handleFileUpload = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                setIsProcessing(true);
                
                setTimeout(() => {
                    const reader = new FileReader();
                    reader.onload = (evt) => {
                        try {
                            const bstr = evt.target.result;
                            const wb = XLSX.read(bstr, { type: 'binary' });
                            setWorkbook(wb);
                            if (!wb.SheetNames.length) throw new Error("File Kosong");
                            
                            const firstSheet = wb.SheetNames[0];
                            setSheetName(firstSheet);
                            const ws = wb.Sheets[firstSheet];
                            const data = XLSX.utils.sheet_to_json(ws, { header: 1, range: 0, defval: "" });
                            setPreviewData(data.slice(0, 15));
                            setStep(2);
                            showNotify("File berhasil dimuat", "success");
                        } catch (err) {
                            showNotify("Gagal baca file: " + err.message, 'error');
                        } finally {
                            setIsProcessing(false);
                        }
                    };
                    reader.readAsBinaryString(file);
                }, 100);
            };

            const handleCalculateOverstock = () => {
                setIsProcessing(true);
                setTimeout(() => {
                    try {
                        const ws = workbook.Sheets[sheetName];
                        let range = XLSX.utils.decode_range(ws['!ref']);
                        const idxStock = getColIndex(calcConfig.stockCol.toUpperCase());
                        const idxSales = getColIndex(calcConfig.salesCol.toUpperCase());
                        const idxBuffer = getColIndex(calcConfig.bufferCol.toUpperCase());
                        const idxOver = getColIndex(colMapping.overStock.toUpperCase());

                        const headerCellAddress = XLSX.utils.encode_cell({r: headerRowIndex, c: idxOver});
                        ws[headerCellAddress] = { t: 's', v: 'OVER' };

                        let countUpdated = 0;
                        for (let R = headerRowIndex + 1; R <= range.e.r; ++R) {
                            const cellStock = ws[XLSX.utils.encode_cell({r: R, c: idxStock})];
                            const cellSales = ws[XLSX.utils.encode_cell({r: R, c: idxSales})];
                            const cellBuffer = ws[XLSX.utils.encode_cell({r: R, c: idxBuffer})];
                            
                            const valStock = cellStock ? parseSmartNumber(cellStock.v) : 0;
                            const valSales = cellSales ? parseSmartNumber(cellSales.v) : 0;
                            const valBuffer = cellBuffer ? parseSmartNumber(cellBuffer.v) : 0;

                            const safetyStock = (2 * valSales) + valBuffer;
                            let calcOver = Math.max(0, valStock - safetyStock);

                            const cellAddress = XLSX.utils.encode_cell({r: R, c: idxOver});
                            ws[cellAddress] = { t: 'n', v: calcOver };
                            countUpdated++;
                        }
                        
                        if (range.e.c < idxOver) {
                            range.e.c = idxOver;
                            ws['!ref'] = XLSX.utils.encode_range(range);
                        }

                        setWorkbook({...workbook});
                        
                        const newData = XLSX.utils.sheet_to_json(ws, { header: 1, range: 0, defval: "" });
                        setPreviewData(newData.slice(0, 15));
                        showNotify(`Berhasil update ${countUpdated} baris & header "OVER"!`, "success");
                    } catch (err) {
                        console.error(err);
                        showNotify("Error: " + err.message, "error");
                    } finally {
                        setIsProcessing(false);
                    }
                }, 100);
            };

            const handleAnalyze = () => {
                setIsProcessing(true); 
                setTimeout(() => {
                    try {
                        const ws = workbook.Sheets[sheetName];
                        const rawData = XLSX.utils.sheet_to_json(ws, { header: 1, range: headerRowIndex + 1, defval: 0 });

                        if (rawData.length === 0) throw new Error("Tidak ada data di bawah baris header.");

                        const idx = {
                            branch: getColIndex(colMapping.branch.toUpperCase()),
                            code: getColIndex(colMapping.productCode.toUpperCase()),
                            desc: getColIndex(colMapping.productDesc.toUpperCase()),
                            need: getColIndex(colMapping.planDrop.toUpperCase()),
                            over: getColIndex(colMapping.overStock.toUpperCase()),
                            multiple: getColIndex(colMapping.multiple.toUpperCase()),
                        };

                        const hasOver = rawData.some(r => parseSmartNumber(r[idx.over]) > 0);
                        if (!hasOver) {
                            throw new Error("Data Overstock (Kolom AZ) Kosong/Nol semua. Harap klik 'Hitung Update AZ' terlebih dahulu.");
                        }

                        const productGroups = {};

                        for (let i = 0; i < rawData.length; i++) {
                            const row = rawData[i];
                            if (!row || row.length <= idx.code) continue;

                            const pCode = String(row[idx.code]).trim();
                            if (!pCode || pCode === "0") continue;

                            const branchRaw = String(row[idx.branch] || "Unknown").trim().toUpperCase();
                            
                            let multipleVal = parseSmartNumber(row[idx.multiple]);
                            if (multipleVal <= 0) multipleVal = 1;

                            if (!productGroups[pCode]) {
                                productGroups[pCode] = {
                                    desc: row[idx.desc] || "Tanpa Nama",
                                    multiple: multipleVal,
                                    sources: [], destinations: []
                                };
                            }

                            const rayon = getRayon(branchRaw);
                            const overQty = parseSmartNumber(row[idx.over]);
                            const needQty = parseSmartNumber(row[idx.need]);

                            if (overQty > 0) {
                                const sources = productGroups[pCode].sources;
                                let found = false;
                                for(let j=0; j<sources.length; j++) {
                                    if(sources[j].branch === branchRaw) {
                                        sources[j].qty += overQty;
                                        sources[j].initialOver += overQty;
                                        found = true; break;
                                    }
                                }
                                if(!found) sources.push({ branch: branchRaw, rayon, qty: overQty, initialOver: overQty });
                            }

                            if (needQty > 0) {
                                const dests = productGroups[pCode].destinations;
                                let found = false;
                                for(let j=0; j<dests.length; j++) {
                                    if(dests[j].branch === branchRaw) {
                                        dests[j].qty += needQty;
                                        dests[j].initialNeed = dests[j].qty;
                                        found = true; break;
                                    }
                                }
                                if(!found) dests.push({ branch: branchRaw, rayon, qty: needQty, initialNeed: needQty });
                            }
                        }

                        const newSuggestions = [];
                        const tempAllocMap = {};

                        const productKeys = Object.keys(productGroups);
                        for (let k = 0; k < productKeys.length; k++) {
                            const code = productKeys[k];
                            const group = productGroups[code];
                            const K = group.multiple;

                            if (group.sources.length === 0 || group.destinations.length === 0) continue;

                            const potentialDestinations = group.destinations.map(d => ({
                                branch: d.branch, rayon: d.rayon, need: d.initialNeed
                            })).sort((a,b) => b.need - a.need);

                            for(let s=0; s<group.sources.length; s++) group.sources[s].usageCount = 0;
                            group.destinations.sort((a, b) => b.qty - a.qty);

                            const runAllocation = (priorityFilterFn) => {
                                for (let d = 0; d < group.destinations.length; d++) {
                                    const dest = group.destinations[d];
                                    if (dest.qty < K) continue;

                                    let validSources = [];
                                    for(let s=0; s<group.sources.length; s++) {
                                        const src = group.sources[s];
                                        if (src.qty >= K && src.usageCount < 3) {
                                            const score = getPriorityScore(src.rayon, dest.rayon);
                                            if (priorityFilterFn(score)) {
                                                src.tempScore = score; 
                                                validSources.push(src);
                                            }
                                        }
                                    }

                                    if (validSources.length === 0) continue;

                                    validSources.sort((a, b) => {
                                        if (a.tempScore !== b.tempScore) return a.tempScore - b.tempScore;
                                        const aFits = a.qty >= dest.qty;
                                        const bFits = b.qty >= dest.qty;
                                        if (aFits && !bFits) return -1;
                                        if (!aFits && bFits) return 1;
                                        return b.qty - a.qty;
                                    });

                                    for (let i = 0; i < validSources.length; i++) {
                                        if (dest.qty < K) break;
                                        const source = validSources[i];
                                        if (source.tempScore > 5) continue;

                                        const maxPotential = Math.min(dest.qty, source.qty);
                                        const validTransfer = Math.floor(maxPotential / K) * K;

                                        if (validTransfer > 0) {
                                            const allocKey = `${code}_${dest.branch}`;
                                            if (!tempAllocMap[allocKey]) tempAllocMap[allocKey] = { total: 0, need: dest.initialNeed };

                                            newSuggestions.push({
                                                id: Math.random().toString(36).substr(2, 9),
                                                productCode: code,
                                                productDesc: group.desc,
                                                multiple: K,
                                                from: source.branch,
                                                fromRayon: source.rayon,
                                                to: dest.branch,
                                                toRayon: dest.rayon,
                                                qty: validTransfer,
                                                priorityRank: source.tempScore,
                                                sourceInitialOver: source.initialOver,
                                                initialNeed: dest.initialNeed,
                                                availableOptions: potentialDestinations,
                                            });

                                            source.qty -= validTransfer;
                                            dest.qty -= validTransfer;
                                            source.usageCount++;
                                            tempAllocMap[allocKey].total += validTransfer;
                                        }
                                    }
                                }
                            };

                            runAllocation(score => score === 1);
                            runAllocation(score => score > 1 && score <= 5);
                        }

                        setAllocationsMap(tempAllocMap);
                        if (newSuggestions.length === 0) {
                            showNotify("Tidak ditemukan kecocokan stok (Need vs Over) untuk dropping.", "error");
                        } else {
                            setSuggestions(newSuggestions);
                            setStep(3);
                            setCurrentPage(1); 
                            showNotify(`Analisa selesai! Ditemukan ${newSuggestions.length} rekomendasi.`, "success");
                        }
                    } catch (err) {
                        showNotify("Gagal Analisa: " + err.message, "error");
                    } finally {
                        setIsProcessing(false);
                    }
                }, 100); 
            };

            // FUNGSI BARU: Update Qty Manual
            const handleQtyChange = (id, newQty) => {
                const qtyValue = parseInt(newQty) || 0;
                setSuggestions(prev => {
                    const nextState = prev.map(item => {
                        if (item.id !== id) return item;
                        return { ...item, qty: qtyValue };
                    });

                    // Update Peta Alokasi untuk indikator Overflow
                    const newMap = {};
                    nextState.forEach(s => {
                        const key = `${s.productCode}_${s.to}`;
                        if (!newMap[key]) newMap[key] = { total: 0, need: s.initialNeed };
                        newMap[key].total += s.qty;
                    });
                    setAllocationsMap(newMap);
                    return nextState;
                });
            };

            const handleDestinationChange = (id, newBranch) => {
                setSuggestions(prev => {
                    const currentItem = prev.find(item => item.id === id);
                    if (!currentItem) return prev;

                    const targetOption = currentItem.availableOptions.find(o => o.branch === newBranch);
                    if (!targetOption) return prev;

                    const usedByOthers = prev
                        .filter(item => item.id !== id && item.productCode === currentItem.productCode && item.from === currentItem.from)
                        .reduce((sum, item) => sum + item.qty, 0);

                    const availableSourceStock = currentItem.sourceInitialOver - usedByOthers;
                    const newPriority = getPriorityScore(currentItem.fromRayon, targetOption.rayon);
                    
                    let maxTransfer = Math.min(availableSourceStock, targetOption.need);
                    let newQty = Math.floor(maxTransfer / currentItem.multiple) * currentItem.multiple;
                    
                    if (newQty <= 0 && targetOption.need > 0 && availableSourceStock >= currentItem.multiple) {
                        newQty = currentItem.multiple;
                    }

                    const nextState = prev.map(item => {
                        if (item.id !== id) return item;
                        return { 
                            ...item, to: newBranch, toRayon: targetOption.rayon, 
                            qty: newQty, priorityRank: newPriority, initialNeed: targetOption.need 
                        };
                    });
                    
                    const newMap = {};
                    nextState.forEach(s => {
                        const key = `${s.productCode}_${s.to}`;
                        if (!newMap[key]) newMap[key] = { total: 0, need: s.initialNeed };
                        newMap[key].total += s.qty;
                    });
                    setAllocationsMap(newMap);
                    return nextState;
                });
            };

            const downloadCSV = () => {
                if (suggestions.length === 0) return;
                const headers = ["Kode Produk", "Deskripsi", "Prioritas", "Dari Cabang", "Rayon Asal", "Overstok Sumber", "Ke Cabang", "Rayon Tujuan", "Kelipatan", "Qty Transfer"];
                const rows = suggestions.map(s => [
                    s.productCode, `"${s.productDesc || ''}"`, `PRIORITAS ${s.priorityRank}`,
                    s.from, s.fromRayon, s.sourceInitialOver,
                    s.to, s.toRayon, s.multiple, s.qty
                ]);
                const csvContent = "\ufeff" + headers.join(";") + "\n" + rows.map(e => e.join(";")).join("\n");
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement("a");
                link.setAttribute("href", url);
                link.setAttribute("download", "rekomendasi_dropping.csv");
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            };

            const filteredSuggestions = React.useMemo(() => {
                return suggestions.filter(item => {
                    if (searchTerm) {
                        const term = searchTerm.toLowerCase();
                        if (!item.productDesc?.toLowerCase().includes(term) && 
                            !item.productCode?.toLowerCase().includes(term) &&
                            !item.from?.toLowerCase().includes(term) && 
                            !item.to?.toLowerCase().includes(term)) return false;
                    }
                    if (columnFilters.product && !item.productCode.toLowerCase().includes(columnFilters.product.toLowerCase())) return false;
                    if (columnFilters.priority !== 'ALL' && item.priorityRank.toString() !== columnFilters.priority) return false;
                    if (columnFilters.source && !item.from.toLowerCase().includes(columnFilters.source.toLowerCase())) return false;
                    if (columnFilters.destination && !item.to.toLowerCase().includes(columnFilters.destination.toLowerCase())) return false;
                    if (columnFilters.qty && !item.qty.toString().includes(columnFilters.qty)) return false;
                    return true;
                });
            }, [suggestions, searchTerm, columnFilters]);

            const handleFilterChange = (col, val) => {
                setColumnFilters(prev => ({...prev, [col]: val}));
                setCurrentPage(1); 
            };

            const totalPages = Math.ceil(filteredSuggestions.length / itemsPerPage);
            const currentTableData = filteredSuggestions.slice((currentPage - 1) * itemsPerPage, currentPage * itemsPerPage);

            const getPriorityBadgeColor = (rank) => {
                const colors = { 1: 'emerald', 2: 'sky', 3: 'indigo', 4: 'orange', 5: 'rose' };
                const c = colors[rank] || 'gray';
                return `bg-${c}-100 text-${c}-700 border-${c}-200`;
            };

            const getHeaderStyle = (letter) => {
                if (letter === colMapping.branch) return 'bg-red-100 text-red-700 border-red-200';
                if (letter === colMapping.productCode) return 'bg-blue-100 text-blue-700 border-blue-200';
                if (letter === colMapping.productDesc) return 'bg-gray-100 text-gray-700 border-gray-200';
                if (letter === colMapping.planDrop) return 'bg-rose-100 text-rose-700 border-rose-200';
                if (letter === colMapping.overStock) return 'bg-emerald-100 text-emerald-700 border-emerald-200';
                if (letter === colMapping.multiple) return 'bg-violet-100 text-violet-700 border-violet-200';
                return 'bg-gray-50 text-gray-400';
            };

            const getCellStyle = (letter) => {
                if (letter === colMapping.branch) return 'bg-red-50/30 text-red-900 font-medium';
                if (letter === colMapping.productCode) return 'bg-blue-50/30 text-blue-900 font-medium';
                if (letter === colMapping.productDesc) return 'bg-gray-50/30 text-gray-900';
                if (letter === colMapping.planDrop) return 'bg-rose-50/30 text-rose-900 font-medium';
                if (letter === colMapping.overStock) return 'bg-emerald-50/30 text-emerald-900 font-medium';
                if (letter === colMapping.multiple) return 'bg-violet-50/30 text-violet-900';
                return '';
            };

            return (
                <div className="min-h-screen pb-12 relative">
                    {isProcessing && <LoadingOverlay />}
                    <Toast message={notification.message} type={notification.type} onClose={() => setNotification({message: '', type: ''})} />

                    <div className="bg-white border-b border-gray-200 sticky top-0 z-20">
                        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                            <div className="flex justify-between items-center h-16">
                                <div className="flex items-center gap-3">
                                    <div className="bg-blue-600 p-2 rounded-lg text-white"><Icon name="box" size={24} /></div>
                                    <div><h1 className="text-xl font-bold text-gray-900">SCM Optimizer</h1><p className="text-xs text-gray-500">Dropping Allocation System</p></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                        <div className="mb-8 flex justify-center gap-4">
                            {[1, 2, 3].map(s => (
                                <div key={s} className={`w-3 h-3 rounded-full ${step >= s ? 'bg-blue-600' : 'bg-gray-300'}`}></div>
                            ))}
                        </div>

                        {step === 1 && (
                            <div className="glass-panel rounded-2xl p-12 text-center max-w-2xl mx-auto mt-12 animate-fade-in-up">
                                <div className="relative group cursor-pointer w-full">
                                    <input type="file" accept=".xlsx, .xls, .csv" onChange={handleFileUpload} className="absolute inset-0 w-full h-full opacity-0 z-20 cursor-pointer" />
                                    <div className="border-2 border-dashed border-gray-300 rounded-2xl p-12 group-hover:border-blue-500 group-hover:bg-blue-50/50 transition-all flex flex-col items-center justify-center">
                                        <Icon name="upload-cloud" size={40} className="text-blue-500 mb-4" />
                                        <h3 className="text-2xl font-bold text-gray-800 mb-2">Upload Data Stock</h3>
                                        <p className="text-gray-500 mb-6">File Excel (.xlsx)</p>
                                        <div className="bg-blue-600 text-white px-6 py-2 rounded-lg font-semibold">Pilih File</div>
                                    </div>
                                </div>
                            </div>
                        )}

                        {step === 2 && (
                            <div className="space-y-8 animate-fade-in-up">
                                <div className="glass-panel rounded-2xl p-8">
                                    <div className="flex justify-between items-center mb-6">
                                        <h3 className="text-xl font-bold flex gap-2"><Icon name="settings-2"/> Konfigurasi</h3>
                                        <button onClick={handleAnalyze} className="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-xl font-bold flex items-center gap-2 transition-transform active:scale-95">
                                            Jalankan Analisa <Icon name="play" size={18} />
                                        </button>
                                    </div>
                                    <div className="grid grid-cols-12 gap-8">
                                        <div className="col-span-4 space-y-4">
                                            <div className="p-4 bg-blue-50 rounded-xl border border-blue-100">
                                                <label className="text-sm font-bold text-gray-700">Baris Header</label>
                                                <input type="number" value={headerRowIndex+1} onChange={(e)=>setHeaderRowIndex(parseInt(e.target.value)-1)} className="w-20 p-2 ml-2 border rounded text-center"/>
                                            </div>
                                            <div className="grid grid-cols-2 gap-4">
                                                {Object.entries(colMapping).map(([k,v])=>(
                                                    <div key={k} className={k==='productDesc'||k==='multiple'?'col-span-2':''}>
                                                        <label className="text-xs font-bold uppercase text-gray-500">{k}</label>
                                                        <input 
                                                            type="text" 
                                                            value={v} 
                                                            onChange={e=>setColMapping({...colMapping, [k]:e.target.value})} 
                                                            className={`w-full p-2 border rounded font-mono uppercase font-bold ${
                                                                k === 'branch' ? 'text-red-600 border-red-200 bg-red-50' : 
                                                                k === 'productCode' ? 'text-blue-600 border-blue-200 bg-blue-50' : 
                                                                k === 'planDrop' ? 'text-rose-700 border-rose-200 bg-rose-50' : 
                                                                k === 'overStock' ? 'text-emerald-700 border-emerald-200 bg-emerald-50' : 
                                                                k === 'multiple' ? 'text-violet-700 border-violet-200 bg-violet-50' : 
                                                                'text-gray-700'
                                                            }`}
                                                        />
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                        <div className="col-span-8 overflow-auto border rounded-xl max-h-[400px]">
                                            <table className="w-full text-xs">
                                                <thead className="sticky top-0 bg-gray-100 z-10">
                                                    <tr>
                                                        <th className="p-2 border-b text-gray-500">#</th>
                                                        {previewData.length>0 && previewData[0].map((_,i)=>{
                                                            const letter = getColLetter(i);
                                                            const headerClass = getHeaderStyle(letter);
                                                            return <th key={i} className={`p-2 border-b font-mono ${headerClass}`}>{letter}</th>
                                                        })}
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {previewData.map((r,ri)=><tr key={ri} className={ri===headerRowIndex?'bg-yellow-100 font-bold':''}><td className="p-2 text-center text-gray-400 bg-gray-50">{ri+1}</td>
                                                        {r.map((c,ci)=>{
                                                            const letter = getColLetter(ci);
                                                            const cellClass = getCellStyle(letter);
                                                            return <td key={ci} className={`p-2 border-l truncate max-w-[100px] ${cellClass}`}>{c}</td>
                                                        })}
                                                    </tr>)}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>

                                <div className="bg-gradient-to-r from-amber-50 to-orange-50 rounded-2xl p-6 border border-amber-100 flex items-center justify-between">
                                    <div>
                                        <h3 className="font-bold text-amber-800 flex items-center gap-2">
                                            <Icon name="calculator"/> 
                                            Kalkulator Overstock Otomatis
                                        </h3>
                                        <div className="text-xs text-amber-900/80 mt-1 mb-3">
                                            <p className="font-semibold">Rumus: Over = Stock - ((2 Ã— Sales) + Buffer)</p>
                                            <p className="text-[10px] text-amber-700 mt-0.5 opacity-80">*Otomatis menamai Header <strong>"OVER"</strong> di kolom AZ baris ke-{headerRowIndex+1}.</p>
                                        </div>
                                        <div className="flex gap-4">
                                            {Object.entries(calcConfig).map(([k,v])=>(<div key={k} className="flex items-center gap-2"><span className="text-xs font-bold text-amber-600 uppercase">{k.replace('Col','')}</span><input value={v} onChange={e=>setCalcConfig({...calcConfig,[k]:e.target.value})} className="w-10 p-1 text-center font-mono border rounded"/></div>))}
                                        </div>
                                    </div>
                                    <button onClick={handleCalculateOverstock} className="bg-amber-500 hover:bg-amber-600 text-white px-4 py-2 rounded-lg font-bold shadow-md transition-all active:scale-95">Hitung Update AZ</button>
                                </div>
                            </div>
                        )}

                        {step === 3 && (
                            <div className="space-y-6 animate-fade-in-up">
                                <div className="glass-panel p-4 rounded-xl flex justify-between items-center">
                                    <div><h3 className="font-bold text-gray-800">Hasil Analisa</h3><p className="text-sm text-gray-500">Total: <strong className="text-blue-600">{suggestions.length}</strong> saran.</p></div>
                                    <div className="flex gap-2">
                                        <input placeholder="Cari..." value={searchTerm} onChange={e=>{setSearchTerm(e.target.value); setCurrentPage(1);}} className="p-2 border rounded w-64"/>
                                        <button onClick={downloadCSV} className="bg-emerald-600 hover:bg-emerald-700 text-white px-4 py-2 rounded font-bold flex items-center gap-2 transition-all"><Icon name="download"/> Simpan CSV</button>
                                        <button onClick={()=>{setStep(2);setSuggestions([])}} className="bg-gray-200 hover:bg-gray-300 px-4 py-2 rounded font-bold transition-all">Ulang</button>
                                    </div>
                                </div>

                                <div className="bg-white rounded-xl shadow border overflow-hidden">
                                    <div className="overflow-x-auto min-h-[400px]">
                                        <table className="w-full text-sm text-left">
                                            <thead className="text-xs text-gray-500 uppercase bg-gray-50 sticky top-0 z-10 border-b">
                                                <tr>
                                                    <th className="px-6 py-4 font-bold w-[250px]">Produk
                                                        <input className="w-full mt-1 p-1 border rounded font-normal" placeholder="Filter..." value={columnFilters.product} onChange={e=>handleFilterChange('product',e.target.value)}/>
                                                    </th>
                                                    <th className="px-6 py-4 text-center font-bold w-[120px]">Prioritas
                                                        <select className="w-full mt-1 p-1 border rounded font-normal" value={columnFilters.priority} onChange={e=>handleFilterChange('priority',e.target.value)}>
                                                            <option value="ALL">All</option><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option>
                                                        </select>
                                                    </th>
                                                    <th className="px-6 py-4 bg-emerald-50/50 font-bold border-l border-emerald-100 min-w-[200px]">Sumber
                                                        <input className="w-full mt-1 p-1 border rounded font-normal bg-white" placeholder="Cari..." value={columnFilters.source} onChange={e=>handleFilterChange('source',e.target.value)}/>
                                                    </th>
                                                    <th className="px-2"></th>
                                                    <th className="px-6 py-4 bg-rose-50/50 font-bold border-r border-rose-100 min-w-[250px]">Tujuan
                                                        <input className="w-full mt-1 p-1 border rounded font-normal bg-white" placeholder="Cari..." value={columnFilters.destination} onChange={e=>handleFilterChange('destination',e.target.value)}/>
                                                    </th>
                                                    <th className="px-6 py-4 text-right bg-blue-50/50 font-bold w-[120px]">Qty Drop
                                                        <input className="w-full mt-1 p-1 border rounded font-normal text-right bg-white" placeholder="..." value={columnFilters.qty} onChange={e=>handleFilterChange('qty',e.target.value)}/>
                                                    </th>
                                                </tr>
                                            </thead>
                                            <tbody className="divide-y divide-gray-100">
                                                {currentTableData.map(item => {
                                                    const allocKey = `${item.productCode}_${item.to}`;
                                                    const totalAlloc = allocationsMap[allocKey]?.total || 0;
                                                    const need = allocationsMap[allocKey]?.need || 0;
                                                    const isOver = totalAlloc > need;
                                                    return (
                                                        <tr key={item.id} className="hover:bg-blue-50/30 transition-colors">
                                                            <td className="px-6 py-4">
                                                                <div className="font-bold text-gray-900 flex items-center gap-2"><Icon name="box" size={14} className="text-gray-400"/> {item.productCode}</div>
                                                                <div className="text-xs text-gray-500 mt-1 truncate max-w-[200px]" title={item.productDesc}>{item.productDesc}</div>
                                                            </td>
                                                            <td className="px-6 py-4 text-center">
                                                                <span className={`px-2 py-1 rounded text-[10px] font-bold border ${getPriorityBadgeColor(item.priorityRank)}`}>PRIO {item.priorityRank}</span>
                                                            </td>
                                                            <td className="px-6 py-4 bg-emerald-50/30 border-l border-emerald-100 relative group">
                                                                <div className="font-bold text-gray-800">{item.from}</div>
                                                                <div className="text-[10px] text-gray-500">{item.fromRayon}</div>
                                                                <div className="text-[10px] text-emerald-600 font-medium">Over Awal: {item.sourceInitialOver}</div>
                                                            </td>
                                                            <td className="text-center text-gray-300"><Icon name="arrow-right" size={16}/></td>
                                                            <td className="px-6 py-4 bg-rose-50/30 border-r border-rose-100 relative">
                                                                <div className="relative">
                                                                    <select className="w-full p-1 pr-6 border border-rose-200 rounded bg-white text-sm font-bold text-gray-800 focus:ring-1 appearance-none cursor-pointer" 
                                                                        value={item.to} onChange={e=>handleDestinationChange(item.id, e.target.value)}>
                                                                        {item.availableOptions.map((o,i)=><option key={i} value={o.branch}>{o.branch} ({o.need})</option>)}
                                                                    </select>
                                                                    <Icon name="chevron-down" size={14} className="absolute right-2 top-2 text-gray-400 pointer-events-none"/>
                                                                </div>
                                                                <div className={`text-[10px] mt-1 flex justify-between ${isOver?'text-red-600 font-bold':''}`}>
                                                                    <span>Butuh: {need} | Dapat: {totalAlloc}</span>
                                                                    <span className="bg-white px-1 rounded border">{item.toRayon}</span>
                                                                </div>
                                                                {isOver && <div className="text-[10px] text-red-600 font-bold flex items-center gap-1 animate-pulse"><Icon name="alert-triangle" size={10}/> OVERFLOW</div>}
                                                            </td>
                                                            {/* KOLOM QTY: SEKARANG BISA DIKETIK MANUAL */}
                                                            <td className="px-6 py-4 text-right bg-blue-50/20">
                                                                <input 
                                                                    type="number" 
                                                                    className={`w-20 p-1 border rounded text-right font-bold focus:ring-1 focus:ring-blue-500 outline-none ${
                                                                        item.qty > item.sourceInitialOver ? 'bg-red-50 border-red-300 text-red-600' : 'bg-white text-blue-600'
                                                                    }`}
                                                                    value={item.qty}
                                                                    onChange={(e) => handleQtyChange(item.id, e.target.value)}
                                                                />
                                                                <div className="text-[9px] text-blue-400 mt-1">x{item.multiple} (Kelipatan)</div>
                                                                {item.qty > item.sourceInitialOver && (
                                                                    <div className="text-[8px] text-red-500 font-bold mt-1">Melebihi Stock!</div>
                                                                )}
                                                            </td>
                                                        </tr>
                                                    )
                                                })}
                                                {currentTableData.length === 0 && (
                                                    <tr><td colSpan="6" className="p-8 text-center text-gray-400">Tidak ada data dropping yang sesuai prioritas.</td></tr>
                                                )}
                                            </tbody>
                                        </table>
                                    </div>
                                    
                                    <div className="bg-gray-50 px-6 py-4 border-t flex justify-between items-center">
                                        <span className="text-sm text-gray-600">
                                            Halaman <span className="font-bold">{currentPage}</span> dari {totalPages} 
                                            <span className="text-gray-400 ml-2">({filteredSuggestions.length} items)</span>
                                        </span>
                                        <div className="flex gap-2">
                                            <button 
                                                onClick={() => setCurrentPage(p => Math.max(1, p - 1))}
                                                disabled={currentPage === 1}
                                                className="px-4 py-2 border rounded bg-white hover:bg-gray-100 disabled:opacity-50 text-sm font-medium flex items-center gap-1 transition-all"
                                            >
                                                <Icon name="chevron-left" size={16}/> Prev
                                            </button>
                                            <button 
                                                onClick={() => setCurrentPage(p => Math.min(totalPages, p + 1))}
                                                disabled={currentPage === totalPages}
                                                className="px-4 py-2 border rounded bg-white hover:bg-gray-100 disabled:opacity-50 text-sm font-medium flex items-center gap-1 transition-all"
                                            >
                                                Next <Icon name="chevron-right" size={16}/>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
