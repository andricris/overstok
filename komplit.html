<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SCM Dropping Optimizer</title>
    
    <!-- 1. Tailwind CSS (Styling) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. React & ReactDOM (Core) -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- 3. Babel (Agar browser bisa baca kode React JSX) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- 4. SheetJS (Untuk baca Excel) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        body { background-color: #f3f4f6; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .spin { animation: spin 1s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        
        /* Custom Scrollbar for tables */
        .custom-scrollbar::-webkit-scrollbar {
            height: 8px;
            width: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1; 
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #cbd5e1; 
            border-radius: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #94a3b8; 
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // --- 1. DATA RAYONISASI BARU ---
        const RAYON_MAPPING = {
            'BDG': 'JABODUNGTABEK', 'BKS': 'JABODUNGTABEK', 'JKT': 'JABODUNGTABEK', 
            'TGR': 'JABODUNGTABEK', 'BGR': 'JABODUNGTABEK', 'JAK': 'JABODUNGTABEK', 'JKT3': 'JABODUNGTABEK',
            'JMR': 'JAWA TIMUR', 'SBY': 'JAWA TIMUR', 'DPS': 'JAWA TIMUR', 'MLG': 'JAWA TIMUR',
            'SLO': 'JAWA TENGAH', 'YGY': 'JAWA TENGAH', 'SMG': 'JAWA TENGAH', 
            'CRB': 'JAWA TENGAH', 'PWT': 'JAWA TENGAH',
            'PDG': 'SUMATERA', 'JBI': 'SUMATERA', 'PLB': 'SUMATERA', 'PKB': 'SUMATERA',
            'BLP': 'SUMATERA', 'BTM': 'SUMATERA', 'MDN': 'SUMATERA', 'NAD': 'SUMATERA',
            'ACE': 'SUMATERA', 'PLM': 'SUMATERA', 
            'BJM': 'CABANG JAUH', 'PTK': 'CABANG JAUH', 'MDO': 'CABANG JAUH', 
            'MKS': 'CABANG JAUH', 'SMD': 'CABANG JAUH', 'BPN': 'CABANG JAUH', 
            'PLU': 'CABANG JAUH', 'KDI': 'CABANG JAUH'
        };

        // --- 2. SKALA PRIORITAS ---
        const PRIORITY_MATRIX = {
            'JABODUNGTABEK': ['JABODUNGTABEK', 'JAWA TENGAH', 'JAWA TIMUR', 'SUMATERA', 'CABANG JAUH'],
            'JAWA TENGAH':   ['JAWA TENGAH', 'JAWA TIMUR', 'JABODUNGTABEK', 'SUMATERA', 'CABANG JAUH'],
            'JAWA TIMUR':    ['JAWA TIMUR', 'JAWA TENGAH', 'JABODUNGTABEK', 'SUMATERA', 'CABANG JAUH'],
            'SUMATERA':      ['SUMATERA', 'JABODUNGTABEK', 'JAWA TENGAH', 'JAWA TIMUR', 'CABANG JAUH'],
            'CABANG JAUH':   ['JABODUNGTABEK', 'CABANG JAUH', 'JAWA TENGAH', 'JAWA TIMUR', 'SUMATERA']
        };

        // --- ICONS ---
        const IconFile = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><path d="M8 13h2"/><path d="M8 17h2"/><path d="M14 13h2"/><path d="M14 17h2"/></svg>;
        const IconArrowRight = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/></svg>;
        const IconSettings = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.09a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.39a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>;
        const IconCheck = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>;
        const IconDownload = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>;
        const IconSearch = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>;
        const IconPackage = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="16.5" y1="9.4" x2="7.5" y2="4.21"/><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/><polyline points="3.27 6.96 12 12.01 20.73 6.96"/><line x1="12" y1="22.08" x2="12" y2="12"/></svg>;
        const IconMapPin = () => <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg>;
        const IconInfo = () => <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>;
        const IconAlert = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>;
        const IconEdit = () => <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>;
        const IconWarning = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="text-red-500"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>;
        const IconCalculator = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="4" y="2" width="16" height="20" rx="2" ry="2"/><line x1="8" y1="6" x2="16" y2="6"/><line x1="16" y1="14" x2="16" y2="14"/><line x1="16" y1="18" x2="16" y2="18"/><line x1="12" y1="14" x2="12" y2="14"/><line x1="12" y1="18" x2="12" y2="18"/><line x1="8" y1="14" x2="8" y2="14"/><line x1="8" y1="18" x2="8" y2="18"/></svg>;

        // --- HELPER FUNCTIONS ---
        const getColLetter = (colIndex) => {
            let temp, letter = '';
            while (colIndex >= 0) {
                temp = (colIndex) % 26;
                letter = String.fromCharCode(temp + 65) + letter;
                colIndex = (colIndex - temp - 1) / 26;
            }
            return letter;
        };

        const getColIndex = (letter) => {
            let column = 0;
            const length = letter.length;
            for (let i = 0; i < length; i++) {
                column += (letter.charCodeAt(i) - 64) * Math.pow(26, length - i - 1);
            }
            return column - 1;
        };

        const getRayon = (branchCode) => {
            if (!branchCode) return 'UNKNOWN';
            const cleanCode = String(branchCode).toUpperCase().replace(/[^A-Z]/g, '');
            const prefix3 = cleanCode.substring(0, 3);
            if (RAYON_MAPPING[prefix3]) return RAYON_MAPPING[prefix3];
            return 'OTHER';
        };

        const getPriorityScore = (sourceRayon, destRayon) => {
            const priorities = PRIORITY_MATRIX[destRayon];
            if (!priorities) return 99;
            const idx = priorities.indexOf(sourceRayon);
            return idx === -1 ? 99 : idx + 1;
        };

        const parseSmartNumber = (val) => {
            if (typeof val === 'number') return Math.floor(val);
            if (!val) return 0;
            const strVal = String(val).trim();
            if (strVal === '-' || strVal === '') return 0;
            let result = 0;
            if (strVal.includes(',') && !strVal.includes('.')) {
                result = parseFloat(strVal.replace(',', '.'));
            } else {
                result = parseFloat(strVal);
            }
            return Math.floor(result) || 0;
        };

        // --- TOAST COMPONENT ---
        const Toast = ({ message, type, onClose }) => {
            if (!message) return null;
            const bgClass = type === 'error' ? 'bg-red-600' : 'bg-green-600';
            
            return (
                <div className={`fixed top-4 right-4 z-50 text-white px-4 py-3 rounded-lg shadow-lg flex items-center gap-3 animate-fade-in-down ${bgClass}`}>
                    {type === 'error' ? <IconAlert /> : <IconCheck />}
                    <span className="font-medium">{message}</span>
                    <button onClick={onClose} className="opacity-75 hover:opacity-100 font-bold ml-2">âœ•</button>
                </div>
            );
        };

        // --- MAIN APP COMPONENT ---
        const App = () => {
            const [step, setStep] = React.useState(1);
            const [workbook, setWorkbook] = React.useState(null);
            const [sheetName, setSheetName] = React.useState('');
            const [previewData, setPreviewData] = React.useState([]);
            const [headerRowIndex, setHeaderRowIndex] = React.useState(4);
            const [suggestions, setSuggestions] = React.useState([]);
            const [searchTerm, setSearchTerm] = React.useState('');
            
            const [allocationsMap, setAllocationsMap] = React.useState({}); 

            const [columnFilters, setColumnFilters] = React.useState({
                product: '',
                priority: 'ALL',
                source: '',
                destination: '',
                qty: ''
            });
            
            const [notification, setNotification] = React.useState({ message: '', type: '' });

            const showNotify = (msg, type = 'error') => {
                setNotification({ message: msg, type });
                setTimeout(() => setNotification({ message: '', type: '' }), 5000);
            };

            const [colMapping, setColMapping] = React.useState({
                branch: 'A',
                productCode: 'E',
                productDesc: 'F',
                planDrop: 'AY',
                overStock: 'AZ',
                multiple: 'AP'
            });

            // State khusus untuk kalkulator overstock
            const [calcConfig, setCalcConfig] = React.useState({
                stockCol: 'AA', // Gross Stock
                salesCol: 'V',  // Sales Qty
                bufferCol: 'AL' // Buffer/PO Pending
            });

            const handleFileUpload = (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (evt) => {
                    try {
                        const bstr = evt.target.result;
                        const wb = XLSX.read(bstr, { type: 'binary' });
                        setWorkbook(wb);
                        if (!wb.SheetNames.length) { showNotify("File Kosong", 'error'); return; }
                        const firstSheet = wb.SheetNames[0];
                        setSheetName(firstSheet);
                        const ws = wb.Sheets[firstSheet];
                        const data = XLSX.utils.sheet_to_json(ws, { header: 1, range: 0, defval: "" });
                        setPreviewData(data.slice(0, 15));
                        setStep(2);
                        showNotify("File dimuat", "success");
                    } catch (err) {
                        showNotify("Gagal baca file", 'error');
                    }
                };
                reader.readAsBinaryString(file);
            };

            // FUNGSI BARU: HITUNG OVERSTOCK OTOMATIS
            const handleCalculateOverstock = () => {
                try {
                    const ws = workbook.Sheets[sheetName];
                    const range = XLSX.utils.decode_range(ws['!ref']);
                    
                    // Convert column letters to index
                    const idxStock = getColIndex(calcConfig.stockCol.toUpperCase());
                    const idxSales = getColIndex(calcConfig.salesCol.toUpperCase());
                    const idxBuffer = getColIndex(calcConfig.bufferCol.toUpperCase());
                    const idxOver = getColIndex(colMapping.overStock.toUpperCase());

                    let countUpdated = 0;

                    // Iterate semua baris data (mulai setelah header)
                    for (let R = headerRowIndex + 1; R <= range.e.r; ++R) {
                        const cellStock = ws[XLSX.utils.encode_cell({r: R, c: idxStock})];
                        const cellSales = ws[XLSX.utils.encode_cell({r: R, c: idxSales})];
                        const cellBuffer = ws[XLSX.utils.encode_cell({r: R, c: idxBuffer})];
                        
                        const valStock = cellStock ? parseSmartNumber(cellStock.v) : 0;
                        const valSales = cellSales ? parseSmartNumber(cellSales.v) : 0;
                        const valBuffer = cellBuffer ? parseSmartNumber(cellBuffer.v) : 0;

                        // Rumus: Over = AA - ((2 * V) + AL)
                        // Jika hasil <= 0, maka 0
                        const safetyStock = (2 * valSales) + valBuffer;
                        let calcOver = valStock - safetyStock;
                        if (calcOver < 0) calcOver = 0;

                        // Tulis hasil ke kolom Over (AZ)
                        const cellAddress = XLSX.utils.encode_cell({r: R, c: idxOver});
                        
                        // Update worksheet object directly
                        ws[cellAddress] = { t: 'n', v: calcOver };
                        
                        countUpdated++;
                    }

                    // Update Preview Data agar user melihat perubahannya
                    const newData = XLSX.utils.sheet_to_json(ws, { header: 1, range: 0, defval: "" });
                    setPreviewData(newData.slice(0, 15));
                    
                    showNotify(`Berhasil menghitung Overstock untuk ${countUpdated} baris data!`, "success");

                } catch (err) {
                    console.error(err);
                    showNotify("Gagal menghitung: " + err.message, "error");
                }
            };

            const handleAnalyze = () => {
                try {
                    const ws = workbook.Sheets[sheetName];
                    const rawData = XLSX.utils.sheet_to_json(ws, { header: 1, range: headerRowIndex + 1, defval: 0 });

                    const idx = {
                        branch: getColIndex(colMapping.branch.toUpperCase()),
                        code: getColIndex(colMapping.productCode.toUpperCase()),
                        desc: getColIndex(colMapping.productDesc.toUpperCase()),
                        need: getColIndex(colMapping.planDrop.toUpperCase()),
                        over: getColIndex(colMapping.overStock.toUpperCase()),
                        multiple: getColIndex(colMapping.multiple.toUpperCase()),
                    };

                    // --- VALIDASI: CEK APAKAH ADA DATA OVERSTOCK (KOLOM AZ) ---
                    let totalOverstockFound = 0;
                    for(let i=0; i<rawData.length; i++) {
                        const val = parseSmartNumber(rawData[i][idx.over]);
                        if(val > 0) totalOverstockFound += val;
                    }

                    if (totalOverstockFound === 0) {
                        showNotify("Data Overstock (Kolom AZ) Kosong! Harap hitung dulu menggunakan Kalkulator Overstock di bawah.", "error");
                        return; // BLOKIR ANALISA
                    }
                    // -----------------------------------------------------------

                    const productGroups = {};

                    // 1. DATA AGGREGATION & CLEANING
                    rawData.forEach(row => {
                        if (!row || row.length <= idx.code) return;
                        
                        const pCode = String(row[idx.code]).trim();
                        const branchRaw = String(row[idx.branch] || "Unknown").trim().toUpperCase();
                        
                        if (!pCode || !branchRaw) return;
                        
                        let multipleVal = parseSmartNumber(row[idx.multiple]);
                        if (multipleVal <= 0) multipleVal = 1;

                        if (!productGroups[pCode]) {
                            productGroups[pCode] = {
                                desc: row[idx.desc] || "Tanpa Nama",
                                multiple: multipleVal,
                                sources: [],
                                destinations: []
                            };
                        }

                        const rayon = getRayon(branchRaw);
                        const overQty = parseSmartNumber(row[idx.over]);
                        const needQty = parseSmartNumber(row[idx.need]);

                        // AGREGASI SUMBER
                        if (overQty > 0) {
                            const existingSource = productGroups[pCode].sources.find(s => s.branch === branchRaw);
                            if (existingSource) {
                                existingSource.qty += overQty; 
                                existingSource.initialOver += overQty; 
                            } else {
                                productGroups[pCode].sources.push({ 
                                    branch: branchRaw, 
                                    rayon, 
                                    qty: overQty, 
                                    initialOver: overQty
                                });
                            }
                        }
                        
                        // AGREGASI TUJUAN
                        if (needQty > 0) {
                            const existingDest = productGroups[pCode].destinations.find(d => d.branch === branchRaw);
                            if (existingDest) {
                                existingDest.qty += needQty;
                                existingDest.initialNeed = existingDest.qty; 
                            } else {
                                productGroups[pCode].destinations.push({ 
                                    branch: branchRaw, 
                                    rayon, 
                                    qty: needQty,
                                    initialNeed: needQty 
                                });
                            }
                        }
                    });

                    const newSuggestions = [];
                    const tempAllocMap = {}; 

                    Object.keys(productGroups).forEach(code => {
                        const group = productGroups[code];
                        const K = group.multiple;
                        
                        const potentialDestinations = group.destinations.map(d => ({...d})).sort((a,b) => b.qty - a.qty);
                        
                        // Sort Sources & Destinations
                        group.sources.forEach(s => s.usageCount = 0);
                        group.destinations.sort((a, b) => b.qty - a.qty);

                        const allocate = (priorityFilterFn) => {
                            group.destinations.forEach(dest => {
                                if (dest.qty < K) return; 

                                const validSources = group.sources.filter(s => 
                                    s.qty >= K && 
                                    s.usageCount < 3 && 
                                    priorityFilterFn(getPriorityScore(s.rayon, dest.rayon))
                                );

                                validSources.forEach(s => s.tempScore = getPriorityScore(s.rayon, dest.rayon));
                                validSources.sort((a, b) => {
                                    if (a.tempScore !== b.tempScore) return a.tempScore - b.tempScore;
                                    const aFits = a.qty >= dest.qty;
                                    const bFits = b.qty >= dest.qty;
                                    if (aFits && !bFits) return -1;
                                    if (!aFits && bFits) return 1;
                                    return b.qty - a.qty;
                                });

                                for (let i = 0; i < validSources.length; i++) {
                                    if (dest.qty < K) break; 
                                    
                                    const source = validSources[i];
                                    if (source.tempScore > 5) continue;

                                    const maxPotential = Math.min(dest.qty, source.qty);
                                    const validTransfer = Math.floor(maxPotential / K) * K;

                                    if (validTransfer > 0) {
                                        const allocKey = `${code}_${dest.branch}`;
                                        if (!tempAllocMap[allocKey]) tempAllocMap[allocKey] = { total: 0, need: dest.initialNeed };
                                        
                                        if (tempAllocMap[allocKey].total + validTransfer > dest.initialNeed + (K-1)) {
                                            // Skip to prevent over-allocation logic here if needed
                                        }

                                        newSuggestions.push({
                                            id: Math.random().toString(36).substr(2, 9),
                                            productCode: code,
                                            productDesc: group.desc,
                                            multiple: K,
                                            from: source.branch,
                                            fromRayon: source.rayon,
                                            to: dest.branch,
                                            toRayon: dest.rayon,
                                            qty: validTransfer,
                                            priorityRank: source.tempScore,
                                            sourceStockBefore: source.qty,
                                            initialNeed: dest.initialNeed,
                                            
                                            availableOptions: potentialDestinations.map(d => ({
                                                branch: d.branch,
                                                rayon: d.rayon,
                                                need: d.initialNeed 
                                            })),
                                        });

                                        source.qty -= validTransfer;
                                        dest.qty -= validTransfer;
                                        source.usageCount++;
                                        
                                        tempAllocMap[allocKey].total += validTransfer;
                                    }
                                }
                            });
                        };

                        allocate((score) => score === 1);
                        allocate((score) => score > 1 && score <= 5);
                    });
                    
                    setAllocationsMap(tempAllocMap);

                    if (newSuggestions.length === 0) {
                        showNotify("Tidak ada saran dropping", "error");
                    } else {
                        setSuggestions(newSuggestions);
                        setStep(3);
                        showNotify(`Selesai! ${newSuggestions.length} saran.`, "success");
                    }

                } catch (err) {
                    showNotify("Error: " + err.message, "error");
                }
            };

            const handleDestinationChange = (id, newBranch) => {
                setSuggestions(prev => {
                    const newSuggestions = prev.map(item => {
                        if (item.id !== id) return item;
                        const targetOption = item.availableOptions.find(o => o.branch === newBranch);
                        if (!targetOption) return item;

                        const newPriority = getPriorityScore(item.fromRayon, targetOption.rayon);
                        const maxPossible = Math.min(item.sourceStockBefore, 9999); 
                        let newQty = Math.floor(maxPossible / item.multiple) * item.multiple;
                        if (newQty <= 0) newQty = item.multiple; 

                        return {
                            ...item,
                            to: newBranch,
                            toRayon: targetOption.rayon,
                            qty: newQty,
                            priorityRank: newPriority,
                            initialNeed: targetOption.need
                        };
                    });

                    const tempMap = {};
                    newSuggestions.forEach(s => {
                        const key = `${s.productCode}_${s.to}`;
                        if (!tempMap[key]) tempMap[key] = { total: 0, need: s.initialNeed };
                        tempMap[key].total += s.qty;
                    });
                    setAllocationsMap(tempMap);

                    return newSuggestions;
                });
            };

            const downloadCSV = () => {
                if (suggestions.length === 0) return;
                const headers = ["Kode Produk", "Deskripsi", "Prioritas", "Dari Cabang", "Rayon Asal", "Overstok Awal", "Ke Cabang", "Rayon Tujuan", "Kelipatan", "Qty Transfer"];
                const rows = suggestions.map(s => [
                    s.productCode, `"${s.productDesc || ''}"`,
                    `PRIORITAS ${s.priorityRank}`,
                    s.from, s.fromRayon,
                    s.sourceStockBefore,
                    s.to, s.toRayon,
                    s.multiple, s.qty
                ]);
                const csvContent = "data:text/csv;charset=utf-8," + headers.join(";") + "\n" + rows.map(e => e.join(";")).join("\n");
                const link = document.createElement("a");
                link.href = encodeURI(csvContent);
                link.download = "rekomendasi_dropping_final.csv";
                document.body.appendChild(link);
                link.click();
            };

            const filteredSuggestions = React.useMemo(() => {
                return suggestions.filter(item => {
                    const globalMatch = !searchTerm ||
                        item.productDesc?.toLowerCase().includes(searchTerm.toLowerCase()) ||
                        item.productCode?.toLowerCase().includes(searchTerm.toLowerCase()) ||
                        item.from?.toLowerCase().includes(searchTerm.toLowerCase()) ||
                        item.to?.toLowerCase().includes(searchTerm.toLowerCase());
                    if (!globalMatch) return false;

                    const prodMatch = !columnFilters.product || item.productCode.toLowerCase().includes(columnFilters.product.toLowerCase());
                    const priorityMatch = columnFilters.priority === 'ALL' || item.priorityRank.toString() === columnFilters.priority;
                    const sourceMatch = !columnFilters.source || item.from.toLowerCase().includes(columnFilters.source.toLowerCase());
                    const destMatch = !columnFilters.destination || item.to.toLowerCase().includes(columnFilters.destination.toLowerCase());
                    const qtyMatch = !columnFilters.qty || item.qty.toString().includes(columnFilters.qty);

                    return prodMatch && priorityMatch && sourceMatch && destMatch && qtyMatch;
                });
            }, [suggestions, searchTerm, columnFilters]);

            const handleFilterChange = (col, val) => setColumnFilters(prev => ({...prev, [col]: val}));

            const getPriorityBadgeColor = (rank) => {
                switch(rank) {
                    case 1: return 'bg-green-100 text-green-700 border-green-200';
                    case 2: return 'bg-blue-100 text-blue-700 border-blue-200';
                    case 3: return 'bg-yellow-100 text-yellow-700 border-yellow-200';
                    case 4: return 'bg-orange-100 text-orange-700 border-orange-200';
                    case 5: return 'bg-red-100 text-red-700 border-red-200';
                    default: return 'bg-gray-100 text-gray-700 border-gray-200';
                }
            };

            return (
                <div className="min-h-screen bg-gray-50 text-gray-800 font-sans">
                    <Toast message={notification.message} type={notification.type} onClose={() => setNotification({message: '', type: ''})} />

                    <div className="max-w-7xl mx-auto px-4 py-8">
                        <div className="mb-8">
                            <h1 className="text-3xl font-bold text-gray-900 tracking-tight">SCM Dropping Optimizer</h1>
                            <p className="text-gray-600 mt-2">Analisis Rayonisasi (Calculator & Auto-Cleaning).</p>
                        </div>

                        <div className="flex gap-3 mb-8">
                            {[1, 2, 3].map(s => (
                                <div key={s} className={`h-2 flex-1 rounded-full transition-all duration-500 ${step >= s ? 'bg-blue-600 shadow-md' : 'bg-gray-200'}`}></div>
                            ))}
                        </div>

                        {step === 1 && (
                            <div className="bg-white p-8 rounded-2xl shadow-sm border border-gray-100 text-center animate-fade-in-up">
                                <div className="relative group cursor-pointer">
                                    <input type="file" accept=".xlsx, .xls, .csv" onChange={handleFileUpload} className="absolute inset-0 w-full h-full opacity-0 z-10 cursor-pointer" />
                                    <div className="border-3 border-dashed border-gray-300 rounded-xl p-16 group-hover:bg-blue-50 group-hover:border-blue-400 transition-all duration-300">
                                        <div className="w-20 h-20 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center mx-auto mb-6 group-hover:scale-110 transition-transform">
                                            <IconFile />
                                        </div>
                                        <h3 className="text-2xl font-semibold text-gray-800">Upload Data Stock</h3>
                                        <div className="mt-6 inline-block bg-blue-600 text-white px-6 py-2 rounded-full font-medium shadow-lg">Pilih File</div>
                                    </div>
                                </div>
                            </div>
                        )}

                        {step === 2 && (
                            <div className="space-y-6">
                                {/* PANEL UTAMA */}
                                <div className="bg-white p-6 rounded-2xl shadow-sm border border-gray-200 animate-fade-in-up">
                                    <div className="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                                        <h3 className="text-xl font-bold flex gap-2 items-center text-gray-800"><IconSettings /> Konfigurasi Mapping</h3>
                                        <button onClick={handleAnalyze} className="w-full md:w-auto bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-xl font-bold shadow-lg shadow-blue-100 flex items-center justify-center gap-2">
                                            Jalankan Analisa <IconArrowRight />
                                        </button>
                                    </div>
                                    <div className="grid grid-cols-1 xl:grid-cols-2 gap-8">
                                        <div className="space-y-6">
                                            <div className="bg-blue-50/50 p-5 rounded-xl border border-blue-100">
                                                <label className="block text-sm font-bold text-gray-700 mb-2">Baris Header</label>
                                                <input type="number" value={headerRowIndex + 1} onChange={(e) => setHeaderRowIndex(Math.max(0, parseInt(e.target.value) - 1))} className="w-24 p-2 border rounded-lg" />
                                            </div>
                                            <div className="grid grid-cols-2 gap-5">
                                                {Object.entries(colMapping).map(([key, val]) => (
                                                    <div key={key} className={key === 'productDesc' || key === 'multiple' ? 'col-span-2' : 'col-span-1'}>
                                                        <label className="text-xs font-bold text-gray-500 mb-1 block uppercase">{key}</label>
                                                        <input type="text" value={val} onChange={e=>setColMapping({...colMapping, [key]:e.target.value})} className="w-full p-3 border rounded-lg font-mono uppercase bg-gray-50 focus:bg-white focus:ring-2 focus:ring-blue-500 outline-none"/>
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                        <div className="flex flex-col h-full">
                                            <div className="overflow-auto border rounded-xl bg-gray-50 custom-scrollbar flex-grow max-h-[500px]">
                                                <table className="w-full text-xs whitespace-nowrap">
                                                    <thead>
                                                        <tr>
                                                            <th className="p-3 bg-gray-200 sticky top-0 border-b">#</th>
                                                            {previewData.length > 0 && previewData[0].map((_, i) => (
                                                                <th key={i} className="p-3 sticky top-0 border-b bg-gray-200 font-mono">{getColLetter(i)}</th>
                                                            ))}
                                                        </tr>
                                                    </thead>
                                                    <tbody className="bg-white">
                                                        {previewData.map((row, rIdx) => (
                                                            <tr key={rIdx} className={rIdx === headerRowIndex ? 'bg-yellow-50 font-bold' : ''}>
                                                                <td className="p-2 border-b text-center">{rIdx + 1}</td>
                                                                {row.map((cell, cIdx) => <td key={cIdx} className="p-2 border-b border-l truncate max-w-[100px]">{cell}</td>)}
                                                            </tr>
                                                        ))}
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                {/* PANEL KALKULATOR OVERSTOCK */}
                                <div className="bg-yellow-50 p-6 rounded-2xl shadow-sm border border-yellow-200 animate-fade-in-up">
                                    <div className="flex flex-col md:flex-row gap-6 items-end">
                                        <div className="flex-1">
                                            <h3 className="text-lg font-bold flex gap-2 items-center text-yellow-800 mb-2"><IconCalculator /> Kalkulator Overstock Otomatis</h3>
                                            <p className="text-sm text-yellow-700 mb-4">Jika kolom Overstock (AZ) kosong, sistem bisa menghitungnya otomatis: <strong>Over = Stock - ((2 * Sales) + Buffer)</strong></p>
                                            <div className="flex gap-4">
                                                <div>
                                                    <label className="text-xs font-bold text-gray-500 mb-1 block">KOLOM STOCK (AA)</label>
                                                    <input type="text" value={calcConfig.stockCol} onChange={e=>setCalcConfig({...calcConfig, stockCol:e.target.value})} className="w-24 p-2 border rounded font-mono uppercase text-center"/>
                                                </div>
                                                <div>
                                                    <label className="text-xs font-bold text-gray-500 mb-1 block">KOLOM SALES (V)</label>
                                                    <input type="text" value={calcConfig.salesCol} onChange={e=>setCalcConfig({...calcConfig, salesCol:e.target.value})} className="w-24 p-2 border rounded font-mono uppercase text-center"/>
                                                </div>
                                                <div>
                                                    <label className="text-xs font-bold text-gray-500 mb-1 block">BUFFER (AL)</label>
                                                    <input type="text" value={calcConfig.bufferCol} onChange={e=>setCalcConfig({...calcConfig, bufferCol:e.target.value})} className="w-24 p-2 border rounded font-mono uppercase text-center"/>
                                                </div>
                                            </div>
                                        </div>
                                        <button onClick={handleCalculateOverstock} className="bg-yellow-500 hover:bg-yellow-600 text-white px-6 py-3 rounded-xl font-bold shadow-md shadow-yellow-100 flex items-center justify-center gap-2 transition-transform active:scale-95">
                                            <IconCalculator /> Hitung & Update Kolom Over (AZ)
                                        </button>
                                    </div>
                                </div>
                            </div>
                        )}

                        {step === 3 && (
                            <div className="space-y-6 animate-fade-in-up">
                                <div className="flex flex-col md:flex-row justify-between items-end md:items-center gap-4 bg-white p-4 rounded-xl border border-gray-200 shadow-sm">
                                    <div>
                                        <h3 className="text-xl font-bold text-gray-800">Hasil Analisa</h3>
                                        <p className="text-sm text-gray-500">Total: <strong className="text-blue-600">{suggestions.length}</strong> saran.</p>
                                    </div>
                                    <div className="flex gap-2">
                                        <input type="text" placeholder="Cari..." value={searchTerm} onChange={e => setSearchTerm(e.target.value)} className="pl-4 pr-4 py-2 border rounded-lg outline-none focus:ring-1" />
                                        <button onClick={downloadCSV} className="bg-green-600 text-white px-5 py-2 rounded-lg text-sm font-medium flex items-center gap-2"><IconDownload /> CSV</button>
                                        <button onClick={() => { setStep(2); setSuggestions([]); }} className="bg-gray-100 text-gray-700 px-5 py-2 rounded-lg text-sm font-medium">Ulang</button>
                                    </div>
                                </div>

                                <div className="bg-white rounded-2xl shadow-sm border border-gray-200 overflow-hidden">
                                    <div className="overflow-x-auto custom-scrollbar max-h-[600px]">
                                        <table className="w-full text-sm text-left">
                                            <thead className="text-xs text-gray-500 uppercase bg-gray-50 border-b sticky top-0 z-10 shadow-sm">
                                                <tr>
                                                    <th className="px-6 py-4 font-bold align-top min-w-[200px]">Produk</th>
                                                    <th className="px-6 py-4 text-center font-bold align-top">Prioritas</th>
                                                    <th className="px-6 py-4 bg-green-50/50 font-bold align-top">Sumber (Over)</th>
                                                    <th className="px-2 py-4 align-top"></th>
                                                    <th className="px-6 py-4 bg-red-50/50 font-bold align-top min-w-[220px]">Tujuan & Validasi</th>
                                                    <th className="px-6 py-4 text-right bg-blue-50/50 font-bold align-top">Qty</th>
                                                </tr>
                                            </thead>
                                            <tbody className="divide-y divide-gray-100">
                                                {filteredSuggestions.map((item) => {
                                                    const allocKey = `${item.productCode}_${item.to}`;
                                                    const totalAlloc = allocationsMap[allocKey]?.total || 0;
                                                    const need = allocationsMap[allocKey]?.need || 0;
                                                    const isOver = totalAlloc > need;

                                                    return (
                                                        <tr key={item.id} className="hover:bg-gray-50 transition-colors group">
                                                            <td className="px-6 py-4">
                                                                <div className="font-bold text-gray-900 flex items-center gap-2"><IconPackage /> {item.productCode}</div>
                                                                <div className="text-xs text-gray-500 mt-1 truncate max-w-[250px]" title={item.productDesc}>{item.productDesc}</div>
                                                            </td>
                                                            <td className="px-6 py-4 text-center">
                                                                <span className={`inline-flex px-2.5 py-1 rounded-md text-[10px] font-bold border tracking-wide uppercase ${getPriorityBadgeColor(item.priorityRank)}`}>
                                                                    PRIORITAS {item.priorityRank}
                                                                </span>
                                                            </td>
                                                            <td className="px-6 py-4 bg-green-50/20 border-l">
                                                                <div className="font-bold text-gray-800">{item.from}</div>
                                                                <div className="text-[10px] text-gray-500 flex items-center gap-1 mt-0.5"><IconMapPin /> {item.fromRayon}</div>
                                                                <div className="text-[10px] text-green-600 font-semibold mt-1">Sisa Awal: {item.sourceStockBefore}</div>
                                                            </td>
                                                            <td className="px-2 py-4 text-center text-gray-300"><IconArrowRight /></td>
                                                            <td className="px-6 py-4 bg-red-50/20 border-r relative">
                                                                {/* DROPDOWN DESTINATION */}
                                                                <div className="relative">
                                                                    <select 
                                                                        className="w-full p-2 pr-8 border border-red-300 rounded bg-white text-sm font-bold text-gray-800 focus:ring-2 focus:ring-red-500 appearance-none cursor-pointer hover:bg-red-50 transition-colors"
                                                                        value={item.to}
                                                                        onChange={(e) => handleDestinationChange(item.id, e.target.value)}
                                                                    >
                                                                        {item.availableOptions.map((opt, idx) => (
                                                                            <option key={idx} value={opt.branch}>
                                                                                {opt.branch} ({opt.need !== undefined ? opt.need : 'N/A'})
                                                                            </option>
                                                                        ))}
                                                                    </select>
                                                                    <div className="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700">
                                                                        <IconEdit />
                                                                    </div>
                                                                </div>
                                                                {/* WARNING INDICATOR + RAYON INFO */}
                                                                <div className={`text-[10px] mt-1 flex justify-between items-center ${isOver ? 'text-red-700 font-bold' : 'text-gray-500'}`}>
                                                                    <div className="flex flex-col gap-0.5">
                                                                        <span>Butuh: {need} | Dapat: {totalAlloc}</span>
                                                                        <span className="font-semibold text-gray-600 bg-gray-100 px-1 rounded w-fit">{item.toRayon}</span>
                                                                    </div>
                                                                    {isOver && <span className="flex items-center gap-1 bg-red-100 px-1 rounded border border-red-200"><IconWarning/> OVER!</span>}
                                                                </div>
                                                            </td>
                                                            <td className="px-6 py-4 text-right bg-blue-50/20">
                                                                <div className="text-lg font-bold text-blue-600">{item.qty}</div>
                                                                <div className="text-[10px] text-gray-400 font-medium">Kelipatan {item.multiple}</div>
                                                            </td>
                                                        </tr>
                                                    );
                                                })}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
