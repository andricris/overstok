<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SCM Dropping Optimizer - TEST</title>
    
    <!-- 1. Tailwind CSS (Styling) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. React & ReactDOM (Core) -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- 3. Babel (Agar browser bisa baca kode React JSX) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- 4. SheetJS (Untuk baca Excel) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        body { background-color: #f3f4f6; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .spin { animation: spin 1s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        
        /* Custom Scrollbar for tables */
        .custom-scrollbar::-webkit-scrollbar {
            height: 8px;
            width: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1; 
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #cbd5e1; 
            border-radius: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #94a3b8; 
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // --- DATA RAYONISASI ---
        const ISLAND_MAPPING = {
            // JAWA & BALI
            'BDG': 'JAWA', 'JMR': 'JAWA', 'SLO': 'JAWA', 'YGY': 'JAWA',
            'SBY': 'JAWA', 'BKS': 'JAWA', 'SMG': 'JAWA', 'DPS': 'JAWA',
            'MLG': 'JAWA', 'JKT': 'JAWA', 'TGR': 'JAWA', 'CRB': 'JAWA',
            'PWT': 'JAWA', 'BGR': 'JAWA', 'JAK': 'JAWA', 'SRG': 'JAWA',
            
            // SUMATERA
            'PDG': 'SUMATERA', 'JBI': 'SUMATERA', 'PLB': 'SUMATERA',
            'PKB': 'SUMATERA', 'BLP': 'SUMATERA', 'BTM': 'SUMATERA',
            'MDN': 'SUMATERA', 'NAD': 'SUMATERA', 'ACE': 'SUMATERA',
            'PLM': 'SUMATERA',
            
            // CABANG JAUH
            'BJM': 'CABANG JAUH', 'PTK': 'CABANG JAUH', 'MDO': 'CABANG JAUH',
            'MKS': 'CABANG JAUH', 'SMD': 'CABANG JAUH', 'PNK': 'CABANG JAUH',
            'BPN': 'CABANG JAUH', 'PLU': 'CABANG JAUH', 'KDI': 'CABANG JAUH'
        };

        // --- ICONS ---
        const IconUpload = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></svg>;
        const IconFile = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><path d="M8 13h2"/><path d="M8 17h2"/><path d="M14 13h2"/><path d="M14 17h2"/></svg>;
        const IconArrowRight = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="5" y1="12" x2="19" y2="12"/><polyline points="12 5 19 12 12 19"/></svg>;
        const IconSettings = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.09a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.39a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>;
        const IconCheck = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>;
        const IconDownload = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>;
        const IconSearch = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>;
        const IconPackage = () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="16.5" y1="9.4" x2="7.5" y2="4.21"/><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/><polyline points="3.27 6.96 12 12.01 20.73 6.96"/><line x1="12" y1="22.08" x2="12" y2="12"/></svg>;
        const IconMapPin = () => <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg>;
        const IconInfo = () => <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>;
        const IconAlert = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>;
        const IconFilter = () => <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/></svg>;

        // --- HELPER FUNCTIONS ---
        const getColLetter = (colIndex) => {
            let temp, letter = '';
            while (colIndex >= 0) {
                temp = (colIndex) % 26;
                letter = String.fromCharCode(temp + 65) + letter;
                colIndex = (colIndex - temp - 1) / 26;
            }
            return letter;
        };

        const getColIndex = (letter) => {
            let column = 0;
            const length = letter.length;
            for (let i = 0; i < length; i++) {
                column += (letter.charCodeAt(i) - 64) * Math.pow(26, length - i - 1);
            }
            return column - 1;
        };

        const getIsland = (branchCode) => {
            if (!branchCode) return 'UNKNOWN';
            const cleanCode = String(branchCode).toUpperCase().replace(/[^A-Z]/g, '');
            const prefix3 = cleanCode.substring(0, 3);
            if (ISLAND_MAPPING[prefix3]) return ISLAND_MAPPING[prefix3];
            return 'OTHER';
        };

        const parseSmartNumber = (val) => {
            if (typeof val === 'number') return Math.floor(val);
            if (!val) return 0;
            const strVal = String(val).trim();
            if (strVal === '-' || strVal === '') return 0;
            let result = 0;
            if (strVal.includes(',') && !strVal.includes('.')) {
                result = parseFloat(strVal.replace(',', '.'));
            } else {
                result = parseFloat(strVal);
            }
            return Math.floor(result) || 0;
        };

        // --- TOAST COMPONENT ---
        const Toast = ({ message, type, onClose }) => {
            if (!message) return null;
            const bgClass = type === 'error' ? 'bg-red-600' : 'bg-green-600';
            
            return (
                <div className={`fixed top-4 right-4 z-50 text-white px-4 py-3 rounded-lg shadow-lg flex items-center gap-3 animate-fade-in-down ${bgClass}`}>
                    {type === 'error' ? <IconAlert /> : <IconCheck />}
                    <span className="font-medium">{message}</span>
                    <button onClick={onClose} className="opacity-75 hover:opacity-100 font-bold ml-2">âœ•</button>
                </div>
            );
        };

        // --- MAIN APP COMPONENT ---
        const App = () => {
            const [step, setStep] = React.useState(1);
            const [workbook, setWorkbook] = React.useState(null);
            const [sheetName, setSheetName] = React.useState('');
            const [previewData, setPreviewData] = React.useState([]);
            const [headerRowIndex, setHeaderRowIndex] = React.useState(4);
            const [suggestions, setSuggestions] = React.useState([]);
            const [searchTerm, setSearchTerm] = React.useState('');
            
            // New Filter States
            const [columnFilters, setColumnFilters] = React.useState({
                product: '',
                type: 'ALL',
                source: '',
                destination: '',
                qty: ''
            });
            
            // UI States
            const [notification, setNotification] = React.useState({ message: '', type: '' });

            const showNotify = (msg, type = 'error') => {
                setNotification({ message: msg, type });
                setTimeout(() => setNotification({ message: '', type: '' }), 5000);
            };

            // Konfigurasi Kolom Default
            const [colMapping, setColMapping] = React.useState({
                branch: 'A',
                productCode: 'E',
                productDesc: 'F',
                planDrop: 'AY',
                overStock: 'AZ',
                multiple: 'AP'
            });

            // STEP 1: Upload File
            const handleFileUpload = (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (evt) => {
                    try {
                        const bstr = evt.target.result;
                        const wb = XLSX.read(bstr, { type: 'binary' });
                        setWorkbook(wb);

                        if (!wb.SheetNames.length) { 
                            showNotify("File Excel Kosong atau Rusak", 'error'); 
                            return; 
                        }
                        
                        const firstSheet = wb.SheetNames[0];
                        setSheetName(firstSheet);
                        const ws = wb.Sheets[firstSheet];
                        const data = XLSX.utils.sheet_to_json(ws, { header: 1, range: 0, defval: "" });
                        
                        setPreviewData(data.slice(0, 15)); // Preview up to 15 rows
                        setStep(2);
                        showNotify("File berhasil dimuat", "success");
                    } catch (err) {
                        console.error(err);
                        showNotify("Gagal membaca file. Pastikan format .xlsx atau .csv", 'error');
                    }
                };
                reader.readAsBinaryString(file);
            };

            // STEP 2: Analisa Logic
            const handleAnalyze = () => {
                try {
                    const ws = workbook.Sheets[sheetName];
                    const rawData = XLSX.utils.sheet_to_json(ws, { header: 1, range: headerRowIndex + 1, defval: 0 });

                    const idx = {
                        branch: getColIndex(colMapping.branch.toUpperCase()),
                        code: getColIndex(colMapping.productCode.toUpperCase()),
                        desc: getColIndex(colMapping.productDesc.toUpperCase()),
                        need: getColIndex(colMapping.planDrop.toUpperCase()),
                        over: getColIndex(colMapping.overStock.toUpperCase()),
                        multiple: getColIndex(colMapping.multiple.toUpperCase()),
                    };

                    const productGroups = {};

                    rawData.forEach(row => {
                        if (!row || row.length <= idx.code) return;
                        const pCode = row[idx.code];
                        if (!pCode) return;

                        let multipleVal = parseSmartNumber(row[idx.multiple]);
                        if (multipleVal <= 0) multipleVal = 1;

                        if (!productGroups[pCode]) {
                            productGroups[pCode] = {
                                desc: row[idx.desc] || "Tanpa Nama",
                                multiple: multipleVal,
                                sources: [],
                                destinations: []
                            };
                        }

                        const branch = row[idx.branch] || "Unknown";
                        const island = getIsland(branch);
                        const overQty = parseSmartNumber(row[idx.over]);
                        const needQty = parseSmartNumber(row[idx.need]);

                        if (overQty > 0) productGroups[pCode].sources.push({ branch, island, qty: overQty });
                        if (needQty > 0) productGroups[pCode].destinations.push({ branch, island, qty: needQty });
                    });

                    const newSuggestions = [];

                    Object.keys(productGroups).forEach(code => {
                        const group = productGroups[code];
                        const K = group.multiple;

                        // Sort Destinasi (Kebutuhan Terbesar)
                        group.destinations.sort((a, b) => b.qty - a.qty);

                        group.destinations.forEach(dest => {
                            let remainingNeed = dest.qty;

                            // Sort Sumber (Prioritas Rayon)
                            group.sources.sort((a, b) => {
                                const sameA = a.island === dest.island;
                                const sameB = b.island === dest.island;
                                if (sameA && !sameB) return -1;
                                if (!sameA && sameB) return 1;
                                return b.qty - a.qty;
                            });

                            for (let i = 0; i < group.sources.length; i++) {
                                const source = group.sources[i];
                                if (source.qty <= 0 || remainingNeed <= 0) continue;

                                const maxPotential = Math.min(remainingNeed, source.qty);
                                const validTransfer = Math.floor(maxPotential / K) * K;

                                if (validTransfer === 0) continue;

                                const isSameIsland = source.island === dest.island;
                                const transferType = (isSameIsland && source.island !== 'UNKNOWN' && source.island !== 'OTHER') ? "LOCAL" : "INTER_ISLAND";

                                newSuggestions.push({
                                    id: Math.random().toString(36).substr(2, 9),
                                    productCode: code,
                                    productDesc: group.desc,
                                    multiple: K,
                                    from: source.branch,
                                    fromIsland: source.island,
                                    to: dest.branch,
                                    toIsland: dest.island,
                                    qty: validTransfer,
                                    transferType: transferType,
                                    sourceStockBefore: source.qty
                                });

                                source.qty -= validTransfer;
                                remainingNeed -= validTransfer;
                                if (remainingNeed < K) break;
                            }
                        });
                    });

                    if (newSuggestions.length === 0) {
                        showNotify("Tidak ditemukan saran dropping (data mungkin sudah seimbang atau tidak ada match)", "error");
                    } else {
                        setSuggestions(newSuggestions);
                        setStep(3);
                        showNotify(`Analisa Selesai! Ditemukan ${newSuggestions.length} saran dropping.`, "success");
                    }

                } catch (err) {
                    showNotify("Error saat analisa: " + err.message, "error");
                }
            };

            // Download CSV
            const downloadCSV = () => {
                if (suggestions.length === 0) return;
                
                const headers = ["Kode Produk", "Deskripsi", "Tipe Transfer", "Dari Cabang", "Rayon Asal", "Overstok Awal", "Ke Cabang", "Rayon Tujuan", "Kelipatan", "Qty Transfer"];
                const rows = suggestions.map(s => [
                    s.productCode, `"${s.productDesc || ''}"`,
                    s.transferType === 'LOCAL' ? 'SATU RAYON' : 'LUAR RAYON',
                    s.from, s.fromIsland,
                    s.sourceStockBefore,
                    s.to, s.toIsland,
                    s.multiple, s.qty
                ]);
                const csvContent = "data:text/csv;charset=utf-8," + headers.join(";") + "\n" + rows.map(e => e.join(";")).join("\n");
                const link = document.createElement("a");
                link.href = encodeURI(csvContent);
                link.download = "rekomendasi_dropping_final.csv";
                document.body.appendChild(link);
                link.click();
            };

            // FILTER LOGIC
            const filteredSuggestions = React.useMemo(() => {
                return suggestions.filter(item => {
                    // 1. Global Search (Existing)
                    const globalMatch = !searchTerm ||
                        item.productDesc?.toLowerCase().includes(searchTerm.toLowerCase()) ||
                        item.productCode?.toLowerCase().includes(searchTerm.toLowerCase()) ||
                        item.from?.toLowerCase().includes(searchTerm.toLowerCase()) ||
                        item.to?.toLowerCase().includes(searchTerm.toLowerCase());
                    
                    if (!globalMatch) return false;

                    // 2. Column Filters
                    const prodMatch = !columnFilters.product || 
                        item.productCode.toLowerCase().includes(columnFilters.product.toLowerCase()) ||
                        item.productDesc.toLowerCase().includes(columnFilters.product.toLowerCase());
                    
                    const typeMatch = columnFilters.type === 'ALL' || item.transferType === columnFilters.type;
                    
                    const sourceMatch = !columnFilters.source ||
                        item.from.toLowerCase().includes(columnFilters.source.toLowerCase()) ||
                        item.fromIsland.toLowerCase().includes(columnFilters.source.toLowerCase());
                    
                    const destMatch = !columnFilters.destination ||
                        item.to.toLowerCase().includes(columnFilters.destination.toLowerCase()) ||
                        item.toIsland.toLowerCase().includes(columnFilters.destination.toLowerCase());
                    
                    const qtyMatch = !columnFilters.qty || item.qty.toString().includes(columnFilters.qty);

                    return prodMatch && typeMatch && sourceMatch && destMatch && qtyMatch;
                });
            }, [suggestions, searchTerm, columnFilters]);

            const handleFilterChange = (col, val) => {
                setColumnFilters(prev => ({...prev, [col]: val}));
            };

            // --- UI RENDERING ---
            return (
                <div className="min-h-screen bg-gray-50 text-gray-800 font-sans">
                    <Toast message={notification.message} type={notification.type} onClose={() => setNotification({message: '', type: ''})} />

                    <div className="max-w-7xl mx-auto px-4 py-8">
                        <div className="mb-8">
                            <h1 className="text-3xl font-bold text-gray-900 tracking-tight">SCM Dropping Optimizer</h1>
                            <p className="text-gray-600 mt-2">Analisis Rayonisasi otomatis untuk Jawa, Sumatera, dan Cabang Jauh.</p>
                        </div>

                        {/* Progress Bar */}
                        <div className="flex gap-3 mb-8">
                            {[1, 2, 3].map(s => (
                                <div key={s} className={`h-2 flex-1 rounded-full transition-all duration-500 ${step >= s ? 'bg-blue-600 shadow-md' : 'bg-gray-200'}`}></div>
                            ))}
                        </div>

                        {/* STEP 1: UPLOAD */}
                        {step === 1 && (
                            <div className="bg-white p-8 rounded-2xl shadow-sm border border-gray-100 text-center animate-fade-in-up">
                                <div className="relative group cursor-pointer">
                                    <input type="file" accept=".xlsx, .xls, .csv" onChange={handleFileUpload} className="absolute inset-0 w-full h-full opacity-0 z-10 cursor-pointer" />
                                    <div className="border-3 border-dashed border-gray-300 rounded-xl p-16 group-hover:bg-blue-50 group-hover:border-blue-400 transition-all duration-300">
                                        <div className="w-20 h-20 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center mx-auto mb-6 group-hover:scale-110 transition-transform">
                                            <IconFile />
                                        </div>
                                        <h3 className="text-2xl font-semibold text-gray-800">Upload Data Stock</h3>
                                        <p className="text-gray-500 mt-2">Format yang didukung: .xlsx, .xls</p>
                                        <div className="mt-6 inline-block bg-blue-600 text-white px-6 py-2 rounded-full font-medium shadow-lg shadow-blue-200 group-hover:shadow-blue-300">Pilih File</div>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* STEP 2: CONFIG */}
                        {step === 2 && (
                            <div className="bg-white p-6 rounded-2xl shadow-sm border border-gray-200 animate-fade-in-up">
                                <div className="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                                    <h3 className="text-xl font-bold flex gap-2 items-center text-gray-800"><IconSettings /> Konfigurasi Mapping Kolom</h3>
                                    <button onClick={handleAnalyze} className="w-full md:w-auto bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-xl font-bold shadow-lg shadow-blue-100 flex items-center justify-center gap-2 transition-transform hover:-translate-y-1 active:translate-y-0">
                                        Jalankan Analisa <IconArrowRight />
                                    </button>
                                </div>
                                
                                <div className="grid grid-cols-1 xl:grid-cols-2 gap-8">
                                    <div className="space-y-6">
                                        <div className="bg-blue-50/50 p-5 rounded-xl border border-blue-100">
                                            <label className="block text-sm font-bold text-gray-700 mb-2">Baris Header Data (Angka)</label>
                                            <p className="text-xs text-gray-500 mb-2">Baris di mana nama kolom berada (contoh: baris ke-4)</p>
                                            <input type="number" value={headerRowIndex + 1} onChange={(e) => setHeaderRowIndex(Math.max(0, parseInt(e.target.value) - 1))} className="w-24 p-2 border border-blue-200 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" />
                                        </div>
                                        
                                        <div className="grid grid-cols-2 gap-5">
                                            <div className="col-span-1">
                                                <label className="text-xs font-bold text-gray-500 mb-1 block">CABANG (Column Letter)</label>
                                                <input type="text" value={colMapping.branch} onChange={e=>setColMapping({...colMapping, branch:e.target.value})} className="w-full p-3 border rounded-lg font-mono uppercase bg-gray-50 focus:bg-white focus:ring-2 focus:ring-blue-500 outline-none"/>
                                            </div>
                                            <div className="col-span-1">
                                                <label className="text-xs font-bold text-gray-500 mb-1 block">KODE PRODUK</label>
                                                <input type="text" value={colMapping.productCode} onChange={e=>setColMapping({...colMapping, productCode:e.target.value})} className="w-full p-3 border rounded-lg font-mono uppercase bg-gray-50 focus:bg-white focus:ring-2 focus:ring-blue-500 outline-none"/>
                                            </div>
                                            <div className="col-span-2">
                                                <label className="text-xs font-bold text-gray-500 mb-1 block">DESKRIPSI PRODUK</label>
                                                <input type="text" value={colMapping.productDesc} onChange={e=>setColMapping({...colMapping, productDesc:e.target.value})} className="w-full p-3 border rounded-lg font-mono uppercase bg-gray-50 focus:bg-white focus:ring-2 focus:ring-blue-500 outline-none"/>
                                            </div>
                                            
                                            <div className="col-span-1">
                                                <label className="text-xs font-bold text-green-700 mb-1 block">KOLOM OVER STOCK</label>
                                                <input type="text" value={colMapping.overStock} onChange={e=>setColMapping({...colMapping, overStock:e.target.value})} className="w-full p-3 border-2 border-green-200 bg-green-50 rounded-lg font-mono uppercase focus:ring-2 focus:ring-green-500 outline-none"/>
                                            </div>
                                            <div className="col-span-1">
                                                <label className="text-xs font-bold text-red-700 mb-1 block">KOLOM KEBUTUHAN (BUTUH)</label>
                                                <input type="text" value={colMapping.planDrop} onChange={e=>setColMapping({...colMapping, planDrop:e.target.value})} className="w-full p-3 border-2 border-red-200 bg-red-50 rounded-lg font-mono uppercase focus:ring-2 focus:ring-red-500 outline-none"/>
                                            </div>
                                            <div className="col-span-2">
                                                <label className="text-xs font-bold text-purple-700 mb-1 block">KELIPATAN (QSP)</label>
                                                <input type="text" value={colMapping.multiple} onChange={e=>setColMapping({...colMapping, multiple:e.target.value})} className="w-full p-3 border-2 border-purple-200 bg-purple-50 rounded-lg font-mono uppercase focus:ring-2 focus:ring-purple-500 outline-none"/>
                                            </div>
                                        </div>
                                    </div>

                                    <div className="flex flex-col h-full">
                                        <label className="text-sm font-bold text-gray-700 mb-2">Preview Data (Baris 1-15)</label>
                                        <div className="overflow-auto border rounded-xl bg-gray-50 custom-scrollbar flex-grow max-h-[500px] shadow-inner">
                                            <table className="w-full text-xs whitespace-nowrap">
                                                <thead>
                                                    <tr>
                                                        <th className="p-3 bg-gray-200 sticky top-0 border-b text-center font-bold text-gray-600 z-10">#</th>
                                                        {previewData.length > 0 && previewData[0].map((_, i) => {
                                                            const letter = getColLetter(i);
                                                            let bgClass = 'bg-gray-200 text-gray-600';
                                                            if (letter === colMapping.overStock) bgClass = 'bg-green-200 text-green-800';
                                                            else if (letter === colMapping.planDrop) bgClass = 'bg-red-200 text-red-800';
                                                            else if (letter === colMapping.branch || letter === colMapping.productCode) bgClass = 'bg-blue-200 text-blue-800';
                                                            
                                                            return (
                                                                <th key={i} className={`p-3 sticky top-0 border-b text-center font-mono font-bold z-10 ${bgClass}`}>
                                                                    {letter}
                                                                </th>
                                                            );
                                                        })}
                                                    </tr>
                                                </thead>
                                                <tbody className="bg-white">
                                                    {previewData.map((row, rIdx) => (
                                                        <tr key={rIdx} className={`hover:bg-blue-50 transition-colors ${rIdx === headerRowIndex ? 'bg-yellow-50 font-bold border-y-2 border-yellow-200' : ''}`}>
                                                            <td className="p-2 border-b text-center text-gray-400 select-none">{rIdx + 1}</td>
                                                            {row.map((cell, cIdx) => <td key={cIdx} className="p-2 border-b border-l truncate max-w-[120px]">{cell}</td>)}
                                                        </tr>
                                                    ))}
                                                </tbody>
                                            </table>
                                        </div>
                                        <p className="text-xs text-gray-500 mt-2 text-right">*Pastikan kolom berwarna sesuai dengan data yang benar.</p>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* STEP 3: RESULT */}
                        {step === 3 && (
                            <div className="space-y-6 animate-fade-in-up">
                                <div className="flex flex-col md:flex-row justify-between items-end md:items-center gap-4 bg-white p-4 rounded-xl border border-gray-200 shadow-sm">
                                    <div>
                                        <h3 className="text-xl font-bold text-gray-800">Hasil Analisa</h3>
                                        <p className="text-sm text-gray-500">Ditemukan <strong className="text-blue-600">{suggestions.length}</strong> potensi transfer barang.</p>
                                    </div>
                                    <div className="flex flex-col sm:flex-row gap-2 w-full md:w-auto">
                                        <div className="relative flex-grow">
                                            <div className="absolute left-3 top-2.5 text-gray-400"><IconSearch /></div>
                                            <input type="text" placeholder="Global Search..." value={searchTerm} onChange={e => setSearchTerm(e.target.value)} className="pl-10 pr-4 py-2 border rounded-lg w-full focus:ring-2 focus:ring-blue-500 outline-none" />
                                        </div>
                                        <button onClick={downloadCSV} className="bg-green-600 hover:bg-green-700 text-white px-5 py-2 rounded-lg text-sm font-medium flex items-center justify-center gap-2 shadow-sm transition-colors">
                                            <IconDownload /> Download CSV
                                        </button>
                                        <button onClick={() => { setStep(2); setSuggestions([]); }} className="bg-gray-100 hover:bg-gray-200 text-gray-700 px-5 py-2 rounded-lg text-sm font-medium transition-colors">
                                            Analisa Ulang
                                        </button>
                                    </div>
                                </div>

                                <div className="bg-white rounded-2xl shadow-sm border border-gray-200 overflow-hidden">
                                    <div className="overflow-x-auto custom-scrollbar max-h-[600px]">
                                        <table className="w-full text-sm text-left">
                                            <thead className="text-xs text-gray-500 uppercase bg-gray-50 border-b sticky top-0 z-10 shadow-sm">
                                                <tr>
                                                    {/* PRODUK HEADER + FILTER */}
                                                    <th className="px-6 py-4 font-bold tracking-wider align-top min-w-[200px]">
                                                        <div className="mb-2">Produk</div>
                                                        <input 
                                                            type="text" 
                                                            placeholder="Filter Kode/Nama..." 
                                                            className="w-full p-1.5 border rounded text-xs font-normal normal-case focus:ring-1 focus:ring-blue-500 outline-none"
                                                            value={columnFilters.product}
                                                            onChange={e => handleFilterChange('product', e.target.value)}
                                                        />
                                                    </th>

                                                    {/* TIPE HEADER + FILTER */}
                                                    <th className="px-6 py-4 text-center font-bold tracking-wider align-top">
                                                        <div className="mb-2">Tipe</div>
                                                        <select 
                                                            className="w-full p-1.5 border rounded text-xs font-normal normal-case focus:ring-1 focus:ring-blue-500 outline-none"
                                                            value={columnFilters.type}
                                                            onChange={e => handleFilterChange('type', e.target.value)}
                                                        >
                                                            <option value="ALL">Semua</option>
                                                            <option value="LOCAL">Satu Rayon</option>
                                                            <option value="INTER_ISLAND">Luar Rayon</option>
                                                        </select>
                                                    </th>

                                                    {/* SUMBER HEADER + FILTER */}
                                                    <th className="px-6 py-4 bg-green-50/50 font-bold tracking-wider border-l align-top min-w-[150px]">
                                                        <div className="mb-2 text-green-800">Sumber (Over)</div>
                                                        <input 
                                                            type="text" 
                                                            placeholder="Filter Cabang..." 
                                                            className="w-full p-1.5 border border-green-200 rounded text-xs font-normal normal-case focus:ring-1 focus:ring-green-500 outline-none"
                                                            value={columnFilters.source}
                                                            onChange={e => handleFilterChange('source', e.target.value)}
                                                        />
                                                    </th>

                                                    <th className="px-2 py-4 text-center bg-gray-50 align-top"></th>

                                                    {/* TUJUAN HEADER + FILTER */}
                                                    <th className="px-6 py-4 bg-red-50/50 font-bold tracking-wider border-r align-top min-w-[150px]">
                                                        <div className="mb-2 text-red-800">Tujuan (Butuh)</div>
                                                        <input 
                                                            type="text" 
                                                            placeholder="Filter Cabang..." 
                                                            className="w-full p-1.5 border border-red-200 rounded text-xs font-normal normal-case focus:ring-1 focus:ring-red-500 outline-none"
                                                            value={columnFilters.destination}
                                                            onChange={e => handleFilterChange('destination', e.target.value)}
                                                        />
                                                    </th>

                                                    {/* QTY HEADER + FILTER */}
                                                    <th className="px-6 py-4 text-right bg-blue-50/50 font-bold tracking-wider align-top min-w-[100px]">
                                                        <div className="mb-2 text-blue-800">Qty Transfer</div>
                                                        <input 
                                                            type="text" 
                                                            placeholder="Filter Qty..." 
                                                            className="w-full p-1.5 border border-blue-200 rounded text-xs font-normal normal-case text-right focus:ring-1 focus:ring-blue-500 outline-none"
                                                            value={columnFilters.qty}
                                                            onChange={e => handleFilterChange('qty', e.target.value)}
                                                        />
                                                    </th>
                                                </tr>
                                            </thead>
                                            <tbody className="divide-y divide-gray-100">
                                                {filteredSuggestions.map((item) => (
                                                    <tr key={item.id} className="hover:bg-gray-50 transition-colors group">
                                                        <td className="px-6 py-4">
                                                            <div className="font-bold text-gray-900 flex items-center gap-2"><IconPackage /> {item.productCode}</div>
                                                            <div className="text-xs text-gray-500 mt-1 truncate max-w-[250px]" title={item.productDesc}>{item.productDesc}</div>
                                                        </td>
                                                        <td className="px-6 py-4 text-center">
                                                            <span className={`inline-flex px-2.5 py-1 rounded-md text-[10px] font-bold border tracking-wide uppercase ${item.transferType === 'LOCAL' ? 'bg-green-100 text-green-700 border-green-200' : 'bg-orange-100 text-orange-700 border-orange-200'}`}>
                                                                {item.transferType === 'LOCAL' ? 'SATU RAYON' : 'LUAR RAYON'}
                                                            </span>
                                                        </td>
                                                        <td className="px-6 py-4 bg-green-50/20 border-l group-hover:bg-green-50/40 transition-colors">
                                                            <div className="font-bold text-gray-800">{item.from}</div>
                                                            <div className="text-[10px] text-gray-500 flex items-center gap-1 mt-0.5"><IconMapPin /> {item.fromIsland}</div>
                                                            <div className="text-[10px] text-green-600 font-semibold mt-1 bg-green-100 inline-block px-1.5 rounded">Overstok: {item.sourceStockBefore}</div>
                                                        </td>
                                                        <td className="px-2 py-4 text-center text-gray-300 group-hover:text-blue-400 transition-colors"><IconArrowRight /></td>
                                                        <td className="px-6 py-4 bg-red-50/20 border-r group-hover:bg-red-50/40 transition-colors">
                                                            <div className="font-bold text-gray-800">{item.to}</div>
                                                            <div className="text-[10px] text-gray-500 flex items-center gap-1 mt-0.5"><IconMapPin /> {item.toIsland}</div>
                                                        </td>
                                                        <td className="px-6 py-4 text-right bg-blue-50/20 group-hover:bg-blue-50/40 transition-colors">
                                                            <div className="text-lg font-bold text-blue-600">{item.qty}</div>
                                                            <div className="text-[10px] text-gray-400 font-medium">Kelipatan {item.multiple}</div>
                                                        </td>
                                                    </tr>
                                                ))}
                                                {filteredSuggestions.length === 0 && (
                                                    <tr><td colSpan="6" className="p-12 text-center text-gray-400 flex flex-col items-center justify-center gap-2"><IconInfo /><span className="text-sm">Tidak ada data yang cocok dengan filter.</span></td></tr>
                                                )}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
