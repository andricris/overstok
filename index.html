<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SCM Dropping Optimizer</title>
    
    <!-- 1. Tailwind CSS (Styling) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. React & ReactDOM (Core) -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- 3. Babel (Agar browser bisa baca kode React JSX) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- 4. SheetJS (Untuk baca Excel) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        body { 
            background: linear-gradient(135deg, #f6f8ff 0%, #f0f4ff 100%);
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
        }
        
        .glass-card {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.05);
        }
        
        .gradient-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .gradient-button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .gradient-button:hover {
            background: linear-gradient(135deg, #5a6fd8 0%, #6a3f8e 100%);
        }
        
        .spin { animation: spin 1s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .card-hover {
            transition: all 0.3s ease;
        }
        
        .card-hover:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.1);
        }
        
        .progress-step {
            transition: all 0.3s ease;
        }
        
        .progress-step.active {
            transform: scale(1.1);
        }
        
        .upload-area {
            border: 2px dashed rgba(102, 126, 234, 0.3);
            transition: all 0.3s ease;
        }
        
        .upload-area:hover {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.05);
        }
        
        .table-row-hover:hover {
            background: linear-gradient(90deg, rgba(102, 126, 234, 0.05) 0%, rgba(255, 255, 255, 1) 100%);
        }
    </style>
</head>
<body class="min-h-screen">
    <div id="root"></div>

    <script type="text/babel">
        // --- DATA RAYONISASI ---
        const ISLAND_MAPPING = {
            // JAWA & BALI
            'BDG': 'JAWA', 'JMR': 'JAWA', 'SLO': 'JAWA', 'YGY': 'JAWA',
            'SBY': 'JAWA', 'BKS': 'JAWA', 'SMG': 'JAWA', 'DPS': 'JAWA',
            'MLG': 'JAWA', 'JKT': 'JAWA', 'TGR': 'JAWA', 'CRB': 'JAWA',
            'PWT': 'JAWA', 'BGR': 'JAWA', 'JAK': 'JAWA', 'SRG': 'JAWA',
            
            // SUMATERA
            'PDG': 'SUMATERA', 'JBI': 'SUMATERA', 'PLB': 'SUMATERA',
            'PKB': 'SUMATERA', 'BLP': 'SUMATERA', 'BTM': 'SUMATERA',
            'MDN': 'SUMATERA', 'NAD': 'SUMATERA', 'ACE': 'SUMATERA',
            'PLM': 'SUMATERA',
            
            // CABANG JAUH
            'BJM': 'CABANG JAUH', 'PTK': 'CABANG JAUH', 'MDO': 'CABANG JAUH',
            'MKS': 'CABANG JAUH', 'SMD': 'CABANG JAUH', 'PNK': 'CABANG JAUH',
            'BPN': 'CABANG JAUH', 'PLU': 'CABANG JAUH', 'KDI': 'CABANG JAUH'
        };

        // --- ICONS (Enhanced with more variations) ---
        const IconUpload = () => (
            <svg xmlns="http://www.w3.org/2000/svg" className="w-12 h-12 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M9 19l3 3m0 0l3-3m-3 3V10" />
            </svg>
        );
        
        const IconFile = () => (
            <svg xmlns="http://www.w3.org/2000/svg" className="w-10 h-10 text-blue-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
            </svg>
        );
        
        const IconArrowRight = () => (
            <svg xmlns="http://www.w3.org/2000/svg" className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M14 5l7 7m0 0l-7 7m7-7H3" />
            </svg>
        );
        
        const IconSettings = () => (
            <svg xmlns="http://www.w3.org/2000/svg" className="w-6 h-6 text-purple-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
            </svg>
        );
        
        const IconCheck = () => (
            <svg xmlns="http://www.w3.org/2000/svg" className="w-6 h-6 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" />
            </svg>
        );
        
        const IconDownload = () => (
            <svg xmlns="http://www.w3.org/2000/svg" className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
            </svg>
        );
        
        const IconSearch = () => (
            <svg xmlns="http://www.w3.org/2000/svg" className="w-5 h-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
            </svg>
        );
        
        const IconPackage = () => (
            <svg xmlns="http://www.w3.org/2000/svg" className="w-5 h-5 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" />
            </svg>
        );
        
        const IconMapPin = () => (
            <svg xmlns="http://www.w3.org/2000/svg" className="w-4 h-4 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
            </svg>
        );
        
        const IconInfo = () => (
            <svg xmlns="http://www.w3.org/2000/svg" className="w-12 h-12 text-gray-300 mx-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1} d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
        );
        
        const IconLoading = () => (
            <svg className="spin w-6 h-6 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
        );
        
        const IconDatabase = () => (
            <svg xmlns="http://www.w3.org/2000/svg" className="w-5 h-5 text-purple-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4m0 5c0 2.21-3.582 4-8 4s-8-1.79-8-4" />
            </svg>
        );
        
        const IconRefresh = () => (
            <svg xmlns="http://www.w3.org/2000/svg" className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
            </svg>
        );

        // --- HELPER FUNCTIONS ---
        const getColLetter = (colIndex) => {
            let temp, letter = '';
            while (colIndex >= 0) {
                temp = (colIndex) % 26;
                letter = String.fromCharCode(temp + 65) + letter;
                colIndex = (colIndex - temp - 1) / 26;
            }
            return letter;
        };

        const getColIndex = (letter) => {
            let column = 0;
            const length = letter.length;
            for (let i = 0; i < length; i++) {
                column += (letter.charCodeAt(i) - 64) * Math.pow(26, length - i - 1);
            }
            return column - 1;
        };

        const getIsland = (branchCode) => {
            if (!branchCode) return 'UNKNOWN';
            const cleanCode = String(branchCode).toUpperCase().replace(/[^A-Z]/g, '');
            const prefix3 = cleanCode.substring(0, 3);
            if (ISLAND_MAPPING[prefix3]) return ISLAND_MAPPING[prefix3];
            return 'OTHER';
        };

        const parseSmartNumber = (val) => {
            if (typeof val === 'number') return Math.floor(val);
            if (!val) return 0;
            const strVal = String(val).trim();
            if (strVal === '-' || strVal === '') return 0;
            let result = 0;
            if (strVal.includes(',') && !strVal.includes('.')) {
                result = parseFloat(strVal.replace(',', '.'));
            } else {
                result = parseFloat(strVal);
            }
            return Math.floor(result) || 0;
        };

        // --- STATISTICS COMPONENT ---
        const StatisticsPanel = ({ suggestions }) => {
            const stats = {
                total: suggestions.length,
                local: suggestions.filter(s => s.transferType === 'LOCAL').length,
                interIsland: suggestions.filter(s => s.transferType !== 'LOCAL').length,
                totalQty: suggestions.reduce((sum, s) => sum + s.qty, 0)
            };

            return (
                <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6 fade-in">
                    <div className="glass-card rounded-xl p-4 card-hover">
                        <div className="flex items-center gap-3">
                            <div className="p-2 bg-blue-100 rounded-lg">
                                <IconDatabase />
                            </div>
                            <div>
                                <p className="text-sm text-gray-500">Total Rekomendasi</p>
                                <p className="text-2xl font-bold text-gray-800">{stats.total}</p>
                            </div>
                        </div>
                    </div>
                    
                    <div className="glass-card rounded-xl p-4 card-hover">
                        <div className="flex items-center gap-3">
                            <div className="p-2 bg-green-100 rounded-lg">
                                <div className="w-6 h-6 flex items-center justify-center">
                                    <div className="w-2 h-2 bg-green-500 rounded-full"></div>
                                </div>
                            </div>
                            <div>
                                <p className="text-sm text-gray-500">Dalam Rayon</p>
                                <p className="text-2xl font-bold text-green-600">{stats.local}</p>
                            </div>
                        </div>
                    </div>
                    
                    <div className="glass-card rounded-xl p-4 card-hover">
                        <div className="flex items-center gap-3">
                            <div className="p-2 bg-yellow-100 rounded-lg">
                                <div className="w-6 h-6 flex items-center justify-center">
                                    <div className="w-2 h-2 bg-yellow-500 rounded-full"></div>
                                </div>
                            </div>
                            <div>
                                <p className="text-sm text-gray-500">Luar Rayon</p>
                                <p className="text-2xl font-bold text-yellow-600">{stats.interIsland}</p>
                            </div>
                        </div>
                    </div>
                    
                    <div className="glass-card rounded-xl p-4 card-hover">
                        <div className="flex items-center gap-3">
                            <div className="p-2 bg-purple-100 rounded-lg">
                                <IconPackage />
                            </div>
                            <div>
                                <p className="text-sm text-gray-500">Total Qty</p>
                                <p className="text-2xl font-bold text-purple-600">{stats.totalQty.toLocaleString()}</p>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // --- STEP INDICATOR COMPONENT ---
        const StepIndicator = ({ step, setStep }) => {
            const steps = [
                { number: 1, label: 'Upload Data', icon: IconUpload },
                { number: 2, label: 'Konfigurasi', icon: IconSettings },
                { number: 3, label: 'Hasil Analisa', icon: IconCheck }
            ];

            return (
                <div className="flex justify-center mb-12">
                    <div className="flex items-center justify-between w-full max-w-2xl relative">
                        {/* Progress Line */}
                        <div className="absolute top-5 left-0 w-full h-1 bg-gray-200 z-0">
                            <div 
                                className="h-1 bg-gradient-to-r from-blue-500 to-purple-500 transition-all duration-500"
                                style={{ width: `${(step - 1) * 50}%` }}
                            ></div>
                        </div>
                        
                        {steps.map((s, index) => {
                            const Icon = s.icon;
                            const isActive = step === s.number;
                            const isCompleted = step > s.number;
                            
                            return (
                                <div key={s.number} className="flex flex-col items-center z-10">
                                    <button
                                        onClick={() => step > s.number && setStep(s.number)}
                                        className={`progress-step w-12 h-12 rounded-full flex items-center justify-center mb-2 transition-all duration-300 ${
                                            isActive 
                                                ? 'gradient-header text-white shadow-lg scale-110' 
                                                : isCompleted 
                                                ? 'bg-gradient-to-r from-green-100 to-emerald-100 text-green-600 border-2 border-green-200'
                                                : 'bg-white text-gray-400 border-2 border-gray-200'
                                        } ${step > s.number ? 'cursor-pointer hover:scale-105' : ''}`}
                                    >
                                        {isCompleted ? <IconCheck /> : <Icon />}
                                    </button>
                                    <span className={`text-sm font-medium ${isActive || isCompleted ? 'text-gray-800' : 'text-gray-400'}`}>
                                        {s.label}
                                    </span>
                                    <span className={`text-xs mt-1 ${isActive || isCompleted ? 'text-blue-600' : 'text-gray-400'}`}>
                                        Step {s.number}
                                    </span>
                                </div>
                            );
                        })}
                    </div>
                </div>
            );
        };

        // --- MAIN APP COMPONENT ---
        const App = () => {
            const [step, setStep] = React.useState(1);
            const [workbook, setWorkbook] = React.useState(null);
            const [sheetName, setSheetName] = React.useState('');
            const [previewData, setPreviewData] = React.useState([]);
            const [headerRowIndex, setHeaderRowIndex] = React.useState(4);
            const [suggestions, setSuggestions] = React.useState([]);
            const [searchTerm, setSearchTerm] = React.useState('');
            
            // Konfigurasi Kolom
            const [colMapping, setColMapping] = React.useState({
                branch: 'A',
                productCode: 'E',
                productDesc: 'F',
                planDrop: 'AY',
                overStock: 'AZ',
                multiple: 'AP'
            });

            // STEP 1: Upload File
            const handleFileUpload = (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (evt) => {
                    try {
                        const bstr = evt.target.result;
                        const wb = XLSX.read(bstr, { type: 'binary' });
                        setWorkbook(wb);

                        if (!wb.SheetNames.length) { alert("Excel Kosong"); return; }
                        
                        const firstSheet = wb.SheetNames[0];
                        setSheetName(firstSheet);
                        const ws = wb.Sheets[firstSheet];
                        const data = XLSX.utils.sheet_to_json(ws, { header: 1, range: 0, defval: "" });
                        
                        setPreviewData(data.slice(0, 10));
                        setStep(2);
                    } catch (err) {
                        console.error(err);
                        alert("Gagal membaca file. Pastikan format .xlsx atau .csv");
                    }
                };
                reader.readAsBinaryString(file);
            };

            // STEP 2: Analisa Logic
            const handleAnalyze = () => {
                try {
                    const ws = workbook.Sheets[sheetName];
                    const rawData = XLSX.utils.sheet_to_json(ws, { header: 1, range: headerRowIndex + 1, defval: 0 });

                    const idx = {
                        branch: getColIndex(colMapping.branch.toUpperCase()),
                        code: getColIndex(colMapping.productCode.toUpperCase()),
                        desc: getColIndex(colMapping.productDesc.toUpperCase()),
                        need: getColIndex(colMapping.planDrop.toUpperCase()),
                        over: getColIndex(colMapping.overStock.toUpperCase()),
                        multiple: getColIndex(colMapping.multiple.toUpperCase()),
                    };

                    const productGroups = {};

                    rawData.forEach(row => {
                        if (!row || row.length <= idx.code) return;
                        const pCode = row[idx.code];
                        if (!pCode) return;

                        let multipleVal = parseSmartNumber(row[idx.multiple]);
                        if (multipleVal <= 0) multipleVal = 1;

                        if (!productGroups[pCode]) {
                            productGroups[pCode] = {
                                desc: row[idx.desc] || "Tanpa Nama",
                                multiple: multipleVal,
                                sources: [],
                                destinations: []
                            };
                        }

                        const branch = row[idx.branch] || "Unknown";
                        const island = getIsland(branch);
                        const overQty = parseSmartNumber(row[idx.over]);
                        const needQty = parseSmartNumber(row[idx.need]);

                        if (overQty > 0) productGroups[pCode].sources.push({ branch, island, qty: overQty });
                        if (needQty > 0) productGroups[pCode].destinations.push({ branch, island, qty: needQty });
                    });

                    const newSuggestions = [];

                    Object.keys(productGroups).forEach(code => {
                        const group = productGroups[code];
                        const K = group.multiple;

                        // Sort Destinasi (Kebutuhan Terbesar)
                        group.destinations.sort((a, b) => b.qty - a.qty);

                        group.destinations.forEach(dest => {
                            let remainingNeed = dest.qty;

                            // Sort Sumber (Prioritas Rayon)
                            group.sources.sort((a, b) => {
                                const sameA = a.island === dest.island;
                                const sameB = b.island === dest.island;
                                if (sameA && !sameB) return -1;
                                if (!sameA && sameB) return 1;
                                return b.qty - a.qty;
                            });

                            for (let i = 0; i < group.sources.length; i++) {
                                const source = group.sources[i];
                                if (source.qty <= 0 || remainingNeed <= 0) continue;

                                const maxPotential = Math.min(remainingNeed, source.qty);
                                const validTransfer = Math.floor(maxPotential / K) * K;

                                if (validTransfer === 0) continue;

                                const isSameIsland = source.island === dest.island;
                                const transferType = (isSameIsland && source.island !== 'UNKNOWN' && source.island !== 'OTHER') ? "LOCAL" : "INTER_ISLAND";

                                newSuggestions.push({
                                    id: Math.random().toString(36).substr(2, 9),
                                    productCode: code,
                                    productDesc: group.desc,
                                    multiple: K,
                                    from: source.branch,
                                    fromIsland: source.island,
                                    to: dest.branch,
                                    toIsland: dest.island,
                                    qty: validTransfer,
                                    transferType: transferType,
                                    sourceStockBefore: source.qty // Capture stock before update
                                });

                                source.qty -= validTransfer;
                                remainingNeed -= validTransfer;
                                if (remainingNeed < K) break;
                            }
                        });
                    });

                    setSuggestions(newSuggestions);
                    setStep(3);

                } catch (err) {
                    alert("Error saat analisa: " + err.message);
                }
            };

            // Download CSV
            const downloadCSV = () => {
                const headers = ["Kode Produk", "Deskripsi", "Tipe Transfer", "Dari Cabang", "Rayon Asal", "Overstok", "Ke Cabang", "Rayon Tujuan", "Kelipatan", "Qty Transfer"];
                const rows = suggestions.map(s => [
                    s.productCode, `"${s.productDesc || ''}"`,
                    s.transferType === 'LOCAL' ? 'SATU RAYON' : 'LUAR RAYON',
                    s.from, s.fromIsland,
                    s.sourceStockBefore, // Add stock info to CSV
                    s.to, s.toIsland,
                    s.multiple, s.qty
                ]);
                const csvContent = "data:text/csv;charset=utf-8," + headers.join(";") + "\n" + rows.map(e => e.join(";")).join("\n");
                const link = document.createElement("a");
                link.href = encodeURI(csvContent);
                link.download = "rekomendasi_dropping_final.csv";
                document.body.appendChild(link);
                link.click();
            };

            const filteredSuggestions = React.useMemo(() => {
                return suggestions.filter(item => 
                    item.productDesc?.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    item.productCode?.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    item.from?.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    item.to?.toLowerCase().includes(searchTerm.toLowerCase())
                );
            }, [suggestions, searchTerm]);

            // --- UI RENDERING ---
            return (
                <div className="max-w-7xl mx-auto px-4 py-8">
                    {/* Header */}
                    <div className="mb-10 fade-in">
                        <div className="flex items-center gap-4 mb-4">
                            <div className="p-3 gradient-header rounded-xl">
                                <IconPackage />
                            </div>
                            <div>
                                <h1 className="text-3xl font-bold text-gray-900">SCM Dropping Optimizer</h1>
                                <p className="text-gray-600 mt-2">Optimasi alokasi stok antar cabang berdasarkan rayonisasi Jawa, Sumatera, dan Cabang Jauh</p>
                            </div>
                        </div>
                        <div className="flex flex-wrap gap-2 mt-4">
                            <span className="px-3 py-1 bg-blue-100 text-blue-700 text-xs font-medium rounded-full">Jawa</span>
                            <span className="px-3 py-1 bg-green-100 text-green-700 text-xs font-medium rounded-full">Sumatera</span>
                            <span className="px-3 py-1 bg-purple-100 text-purple-700 text-xs font-medium rounded-full">Cabang Jauh</span>
                            <span className="px-3 py-1 bg-gray-100 text-gray-700 text-xs font-medium rounded-full">Excel Integration</span>
                        </div>
                    </div>

                    {/* Step Indicator */}
                    <StepIndicator step={step} setStep={setStep} />

                    {/* STEP 1: UPLOAD */}
                    {step === 1 && (
                        <div className="fade-in">
                            <div className="glass-card rounded-2xl p-8 max-w-2xl mx-auto card-hover">
                                <div className="text-center">
                                    <div className="inline-flex items-center justify-center w-20 h-20 bg-gradient-to-br from-blue-50 to-indigo-50 rounded-full mb-6">
                                        <IconUpload />
                                    </div>
                                    <h3 className="text-2xl font-bold text-gray-800 mb-3">Upload Data Excel</h3>
                                    <p className="text-gray-600 mb-8">Upload file Excel yang berisi data overstock dan kebutuhan cabang</p>
                                    
                                    <div className="upload-area rounded-xl p-12 relative mb-6">
                                        <input type="file" accept=".xlsx, .xls, .csv" onChange={handleFileUpload} className="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10" />
                                        <div className="space-y-4">
                                            <div className="flex justify-center">
                                                <IconFile />
                                            </div>
                                            <p className="text-lg font-medium text-gray-700">Tarik file ke sini atau klik untuk memilih</p>
                                            <p className="text-sm text-gray-500">Format yang didukung: .xlsx, .xls, .csv</p>
                                        </div>
                                    </div>
                                    
                                    <div className="bg-gray-50 rounded-lg p-4 text-left">
                                        <h4 className="font-semibold text-gray-700 mb-2">Format file yang diperlukan:</h4>
                                        <ul className="text-sm text-gray-600 space-y-1">
                                            <li>• Kolom cabang (contoh: BDG, SBY, MKS)</li>
                                            <li>• Kolom kode produk dan deskripsi</li>
                                            <li>• Kolom overstock (stok berlebih)</li>
                                            <li>• Kolom plan dropping (kebutuhan)</li>
                                            <li>• Kolom kelipatan packing</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* STEP 2: CONFIG */}
                    {step === 2 && (
                        <div className="fade-in">
                            <div className="glass-card rounded-2xl p-8">
                                <div className="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-8">
                                    <div className="flex items-center gap-3">
                                        <div className="p-2 bg-gradient-to-r from-blue-100 to-purple-100 rounded-lg">
                                            <IconSettings />
                                        </div>
                                        <div>
                                            <h3 className="text-xl font-bold text-gray-800">Konfigurasi Kolom</h3>
                                            <p className="text-sm text-gray-600">Tentukan lokasi kolom data di file Excel Anda</p>
                                        </div>
                                    </div>
                                    <button 
                                        onClick={handleAnalyze} 
                                        className="gradient-button text-white px-8 py-3 rounded-xl font-semibold flex items-center gap-2 shadow-lg hover:shadow-xl transition-all duration-300"
                                    >
                                        Mulai Analisa
                                        <IconArrowRight />
                                    </button>
                                </div>
                                
                                <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
                                    {/* Left Panel - Configuration */}
                                    <div className="space-y-6">
                                        {/* Header Row */}
                                        <div className="glass-card p-5 rounded-xl border border-blue-100">
                                            <label className="block text-sm font-semibold text-gray-700 mb-3">Baris Header Data</label>
                                            <div className="flex items-center gap-4">
                                                <input 
                                                    type="number" 
                                                    value={headerRowIndex + 1} 
                                                    onChange={(e) => setHeaderRowIndex(parseInt(e.target.value) - 1)} 
                                                    className="w-24 p-3 border border-gray-300 rounded-lg text-center font-bold text-lg"
                                                    min="1"
                                                />
                                                <p className="text-sm text-gray-600">Baris ke berapa data header dimulai</p>
                                            </div>
                                        </div>
                                        
                                        {/* Column Mapping */}
                                        <div className="space-y-4">
                                            <h4 className="font-bold text-gray-700">Pemetaan Kolom</h4>
                                            <div className="grid grid-cols-2 gap-4">
                                                {/* Cabang */}
                                                <div className="space-y-2">
                                                    <label className="text-xs font-bold text-gray-500 flex items-center gap-1">
                                                        <span className="w-2 h-2 bg-blue-500 rounded-full"></span>
                                                        CABANG
                                                    </label>
                                                    <input 
                                                        type="text" 
                                                        value={colMapping.branch} 
                                                        onChange={e=>setColMapping({...colMapping, branch:e.target.value})} 
                                                        className="w-full p-3 border-2 border-blue-100 bg-blue-50 rounded-lg font-mono uppercase text-center text-lg font-bold"
                                                    />
                                                </div>
                                                
                                                {/* Kode Produk */}
                                                <div className="space-y-2">
                                                    <label className="text-xs font-bold text-gray-500 flex items-center gap-1">
                                                        <span className="w-2 h-2 bg-gray-500 rounded-full"></span>
                                                        KODE PRODUK
                                                    </label>
                                                    <input 
                                                        type="text" 
                                                        value={colMapping.productCode} 
                                                        onChange={e=>setColMapping({...colMapping, productCode:e.target.value})} 
                                                        className="w-full p-3 border-2 border-gray-100 bg-gray-50 rounded-lg font-mono uppercase text-center text-lg font-bold"
                                                    />
                                                </div>
                                                
                                                {/* Deskripsi */}
                                                <div className="col-span-2 space-y-2">
                                                    <label className="text-xs font-bold text-gray-500 flex items-center gap-1">
                                                        <span className="w-2 h-2 bg-gray-400 rounded-full"></span>
                                                        DESKRIPSI
                                                    </label>
                                                    <input 
                                                        type="text" 
                                                        value={colMapping.productDesc} 
                                                        onChange={e=>setColMapping({...colMapping, productDesc:e.target.value})} 
                                                        className="w-full p-3 border-2 border-gray-100 bg-gray-50 rounded-lg font-mono uppercase text-center text-lg font-bold"
                                                    />
                                                </div>
                                                
                                                {/* Overstock */}
                                                <div className="space-y-2">
                                                    <label className="text-xs font-bold text-green-600 flex items-center gap-1">
                                                        <span className="w-2 h-2 bg-green-500 rounded-full"></span>
                                                        OVERSTOCK
                                                    </label>
                                                    <input 
                                                        type="text" 
                                                        value={colMapping.overStock} 
                                                        onChange={e=>setColMapping({...colMapping, overStock:e.target.value})} 
                                                        className="w-full p-3 border-2 border-green-200 bg-green-50 rounded-lg font-mono uppercase text-center text-lg font-bold text-green-700"
                                                    />
                                                </div>
                                                
                                                {/* Kebutuhan */}
                                                <div className="space-y-2">
                                                    <label className="text-xs font-bold text-red-600 flex items-center gap-1">
                                                        <span className="w-2 h-2 bg-red-500 rounded-full"></span>
                                                        KEBUTUHAN
                                                    </label>
                                                    <input 
                                                        type="text" 
                                                        value={colMapping.planDrop} 
                                                        onChange={e=>setColMapping({...colMapping, planDrop:e.target.value})} 
                                                        className="w-full p-3 border-2 border-red-200 bg-red-50 rounded-lg font-mono uppercase text-center text-lg font-bold text-red-700"
                                                    />
                                                </div>
                                                
                                                {/* Kelipatan */}
                                                <div className="col-span-2 space-y-2">
                                                    <label className="text-xs font-bold text-purple-600 flex items-center gap-1">
                                                        <span className="w-2 h-2 bg-purple-500 rounded-full"></span>
                                                        KELIPATAN PACKING
                                                    </label>
                                                    <input 
                                                        type="text" 
                                                        value={colMapping.multiple} 
                                                        onChange={e=>setColMapping({...colMapping, multiple:e.target.value})} 
                                                        className="w-full p-3 border-2 border-purple-200 bg-purple-50 rounded-lg font-mono uppercase text-center text-lg font-bold text-purple-700"
                                                    />
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    {/* Right Panel - Preview */}
                                    <div className="space-y-4">
                                        <div className="flex items-center justify-between">
                                            <h4 className="font-bold text-gray-700">Preview Data</h4>
                                            <span className="text-xs text-gray-500">10 baris pertama</span>
                                        </div>
                                        <div className="border rounded-xl overflow-hidden shadow-sm max-h-[400px] overflow-y-auto">
                                            <table className="w-full text-xs whitespace-nowrap">
                                                <thead className="sticky top-0 z-10">
                                                    <tr>
                                                        <th className="p-3 bg-gray-800 text-white text-center border-r">#</th>
                                                        {previewData.length > 0 && previewData[0].map((_, i) => (
                                                            <th 
                                                                key={i} 
                                                                className={`p-3 text-center font-mono border-r ${
                                                                    getColLetter(i) === colMapping.overStock ? 'bg-green-100 text-green-800 border-green-200' : 
                                                                    getColLetter(i) === colMapping.planDrop ? 'bg-red-100 text-red-800 border-red-200' : 
                                                                    'bg-gray-100 text-gray-800'
                                                                }`}
                                                            >
                                                                {getColLetter(i)}
                                                            </th>
                                                        ))}
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {previewData.map((row, rIdx) => (
                                                        <tr 
                                                            key={rIdx} 
                                                            className={`${rIdx === headerRowIndex ? 'bg-gradient-to-r from-blue-50 to-indigo-50 font-bold' : ''} hover:bg-gray-50`}
                                                        >
                                                            <td className="p-3 border text-center bg-gray-50 font-medium">{rIdx + 1}</td>
                                                            {row.map((cell, cIdx) => (
                                                                <td 
                                                                    key={cIdx} 
                                                                    className="p-3 border truncate max-w-[120px]"
                                                                    title={String(cell)}
                                                                >
                                                                    {cell}
                                                                </td>
                                                            ))}
                                                        </tr>
                                                    ))}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* STEP 3: RESULT */}
                    {step === 3 && (
                        <div className="space-y-6 fade-in">
                            {/* Header dengan statistik */}
                            <div className="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6">
                                <div>
                                    <h3 className="text-2xl font-bold text-gray-800">Hasil Analisa</h3>
                                    <p className="text-gray-600">Rekomendasi alokasi dropping berdasarkan rayonisasi</p>
                                </div>
                                <div className="flex gap-3">
                                    <div className="relative">
                                        <div className="absolute left-3 top-3">
                                            <IconSearch />
                                        </div>
                                        <input 
                                            type="text" 
                                            placeholder="Cari produk, cabang..." 
                                            value={searchTerm} 
                                            onChange={e => setSearchTerm(e.target.value)} 
                                            className="pl-10 pr-4 py-2.5 border border-gray-300 rounded-xl w-64 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                        />
                                    </div>
                                    <button 
                                        onClick={downloadCSV} 
                                        className="bg-gradient-to-r from-green-500 to-emerald-600 text-white px-5 py-2.5 rounded-xl font-medium flex items-center gap-2 hover:shadow-lg transition-all duration-300"
                                    >
                                        <IconDownload />
                                        Export CSV
                                    </button>
                                    <button 
                                        onClick={() => { setStep(2); setSuggestions([]); }} 
                                        className="bg-white text-gray-700 border border-gray-300 px-5 py-2.5 rounded-xl font-medium flex items-center gap-2 hover:bg-gray-50 transition-all duration-300"
                                    >
                                        <IconRefresh />
                                        Analisa Ulang
                                    </button>
                                </div>
                            </div>

                            {/* Statistics Panel */}
                            <StatisticsPanel suggestions={suggestions} />

                            {/* Results Table */}
                            <div className="glass-card rounded-2xl overflow-hidden shadow-lg">
                                <div className="overflow-x-auto">
                                    <table className="w-full text-sm">
                                        <thead className="bg-gradient-to-r from-gray-50 to-gray-100">
                                            <tr className="text-xs text-gray-700 uppercase border-b">
                                                <th className="px-6 py-4 text-left font-semibold">Produk</th>
                                                <th className="px-6 py-4 text-center font-semibold">Tipe Transfer</th>
                                                <th className="px-6 py-4 text-left font-semibold bg-green-50">Sumber</th>
                                                <th className="px-4 py-4 text-center font-semibold"></th>
                                                <th className="px-6 py-4 text-left font-semibold bg-red-50">Tujuan</th>
                                                <th className="px-6 py-4 text-right font-semibold bg-blue-50">Kuantitas</th>
                                            </tr>
                                        </thead>
                                        <tbody className="divide-y divide-gray-100">
                                            {filteredSuggestions.map((item) => (
                                                <tr key={item.id} className="table-row-hover">
                                                    <td className="px-6 py-4">
                                                        <div className="flex items-center gap-3">
                                                            <div className="p-2 bg-blue-50 rounded-lg">
                                                                <IconPackage />
                                                            </div>
                                                            <div>
                                                                <div className="font-bold text-gray-900">{item.productCode}</div>
                                                                <div className="text-xs text-gray-500 truncate max-w-[200px]" title={item.productDesc}>
                                                                    {item.productDesc}
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </td>
                                                    <td className="px-6 py-4">
                                                        <div className="flex justify-center">
                                                            <span className={`px-3 py-1.5 rounded-full text-xs font-bold border ${
                                                                item.transferType === 'LOCAL' 
                                                                    ? 'bg-gradient-to-r from-green-50 to-emerald-50 text-green-700 border-green-200' 
                                                                    : 'bg-gradient-to-r from-yellow-50 to-amber-50 text-amber-700 border-yellow-200'
                                                            }`}>
                                                                {item.transferType === 'LOCAL' ? 'SATU RAYON' : 'LUAR RAYON'}
                                                            </span>
                                                        </div>
                                                    </td>
                                                    <td className="px-6 py-4 bg-green-50/20">
                                                        <div className="space-y-1">
                                                            <div className="font-semibold text-green-800">{item.from}</div>
                                                            <div className="text-xs text-gray-600 flex items-center gap-1">
                                                                <IconMapPin />
                                                                {item.fromIsland}
                                                            </div>
                                                            <div className="text-xs text-green-600 font-medium">
                                                                Stok: {item.sourceStockBefore.toLocaleString()}
                                                            </div>
                                                        </div>
                                                    </td>
                                                    <td className="px-4 py-4 text-center">
                                                        <div className="inline-flex items-center justify-center w-8 h-8 bg-gradient-to-r from-blue-100 to-indigo-100 rounded-full">
                                                            <IconArrowRight />
                                                        </div>
                                                    </td>
                                                    <td className="px-6 py-4 bg-red-50/20">
                                                        <div className="space-y-1">
                                                            <div className="font-semibold text-red-800">{item.to}</div>
                                                            <div className="text-xs text-gray-600 flex items-center gap-1">
                                                                <IconMapPin />
                                                                {item.toIsland}
                                                            </div>
                                                            <div className="text-xs text-red-600 font-medium">
                                                                Kebutuhan terpenuhi
                                                            </div>
                                                        </div>
                                                    </td>
                                                    <td className="px-6 py-4 text-right bg-blue-50/20">
                                                        <div className="space-y-1">
                                                            <div className="text-lg font-bold text-blue-700">
                                                                {item.qty.toLocaleString()}
                                                            </div>
                                                            <div className="text-xs text-gray-500">
                                                                Kelipatan: {item.multiple} pack
                                                            </div>
                                                        </div>
                                                    </td>
                                                </tr>
                                            ))}
                                            {filteredSuggestions.length === 0 && (
                                                <tr>
                                                    <td colSpan="6" className="p-12 text-center">
                                                        <IconInfo />
                                                        <p className="mt-4 text-gray-500 font-medium">Tidak ada data yang cocok dengan pencarian Anda</p>
                                                        <p className="text-sm text-gray-400 mt-1">Coba ubah kata kunci pencarian</p>
                                                    </td>
                                                </tr>
                                            )}
                                        </tbody>
                                    </table>
                                </div>
                                
                                {/* Footer dengan total */}
                                {filteredSuggestions.length > 0 && (
                                    <div className="bg-gradient-to-r from-gray-50 to-gray-100 px-6 py-4 border-t">
                                        <div className="flex justify-between items-center">
                                            <div className="text-sm text-gray-600">
                                                Menampilkan {filteredSuggestions.length} dari {suggestions.length} rekomendasi
                                            </div>
                                            <div className="text-sm font-semibold text-gray-700">
                                                Total Qty: {filteredSuggestions.reduce((sum, s) => sum + s.qty, 0).toLocaleString()}
                                            </div>
                                        </div>
                                    </div>
                                )}
                            </div>
                            
                            {/* Footer Notes */}
                            <div className="glass-card rounded-xl p-6">
                                <h4 className="font-semibold text-gray-700 mb-3">Keterangan:</h4>
                                <div className="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm text-gray-600">
                                    <div className="flex items-center gap-2">
                                        <div className="w-3 h-3 rounded-full bg-green-500"></div>
                                        <span>SATU RAYON: Transfer dalam rayon yang sama (Jawa ke Jawa, Sumatera ke Sumatera)</span>
                                    </div>
                                    <div className="flex items-center gap-2">
                                        <div className="w-3 h-3 rounded-full bg-yellow-500"></div>
                                        <span>LUAR RAYON: Transfer antar rayon (Jawa ke Sumatera, dll)</span>
                                    </div>
                                    <div className="flex items-center gap-2">
                                        <div className="w-3 h-3 rounded-full bg-blue-500"></div>
                                        <span>Qty sudah disesuaikan dengan kelipatan packing</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
